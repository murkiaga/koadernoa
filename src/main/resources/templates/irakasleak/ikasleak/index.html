<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="eu">
<head>
  <meta charset="UTF-8">
  <title>Ikasleak – [[${koadernoAktiboa != null ? koadernoAktiboa.izena : ''}]]</title>
  <link rel="stylesheet" th:href="@{/css/irakasle-navbar.css}">
  <link rel="stylesheet" th:href="@{/css/irakasle-common.css}">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <style>
	  .page{ /* nahi baduzu, hemen bakarrik gainidatzi dezakezu, baina commons-ek jada definitzen du */
	    max-width:1200px;
	    width:80%;
	    margin:1rem auto;
	    padding:0 1rem 2rem;
	  }
	  h1{ font-size:1.5rem; margin:.5rem 0 1rem; }
	
	  .grid{
	    display:grid;
	    grid-template-columns:repeat(auto-fill, minmax(160px,1fr));
	    gap:12px;
	  }
	
	  .card{
	    position:relative;
	    border-radius:14px;
	    overflow:hidden;
	    background:#fff;
	    box-shadow:0 1px 2px rgba(0,0,0,.04);
	    transition:filter .2s ease, opacity .2s ease;
	  }
	
	  /* MATRIKULATUA ez direnak lausotu — baina soilik irudia */
	  .card[data-egoera]:not([data-egoera="MATRIKULATUA"]) .ph{
	    opacity:.2;
	    filter:grayscale(.3);
	  }
	
	  .media{
	    position:relative;
	    z-index:0;
	    width:100%; height:160px;
	    overflow:hidden; background:#f3f4f6;
	  }
	  .media > img.ph{
	    width:100%; height:100%;
	    display:block; object-fit:cover;
	    background:#f3f4f6;
	  }
	
	  .status-ribbon{
	    position:absolute;
	    left:50%; bottom:8px;
	    transform:translateX(-50%);
	    z-index:5;
	    display:inline-block;
	    max-width:calc(100% - 16px);
	    padding:.22rem .6rem;
	    font-size:.78rem; font-weight:700; letter-spacing:.2px;
	    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
	    background:rgba(255,255,255,.95);
	    border:1px solid #e5e7eb;
	    border-radius:999px;
	    box-shadow:0 2px 6px rgba(0,0,0,.10);
	  }
	
	  .status-ribbon[data-egoera="MATRIKULATUA"]{ color:#065f46; }
	  .status-ribbon[data-egoera="GAINDITUA"]{ color:#1e3a8a; }
	  .status-ribbon[data-egoera="KONBALIDATUA"]{ color:#92400e; }
	  .status-ribbon[data-egoera="PENDIENTE_AURREKO_URTETIK"]{ color:#6b21a8; }
	  .status-ribbon[data-egoera="DESMATRIKULATUA"],
	  .status-ribbon[data-egoera="UKO_EGINA"]{ color:#7f1d1d; }
	
	  .status-btn{
	    position:absolute; top:8px; right:8px;
	    z-index:10;
	    border:1px solid var(--b);
	    background:#fff; color:#111827;
	    border-radius:10px; font-size:.8rem;
	    padding:.25rem .45rem; cursor:pointer;
	    box-shadow:0 2px 6px rgba(0,0,0,.08);
	  }
	  .status-btn:hover{ background:#f9fafb; }
	
	  .meta{ padding:.6rem .75rem .75rem; }
	  .surnames{ font-size:.95rem; color:#111827; line-height:1.1; }
	  .name{ font-weight:700; font-size:1.05rem; line-height:1.2; }
	  .idline{ font-size:.85rem; color:var(--muted); margin-top:.15rem; }
	
	  /* Modal sinplea */
	  .modal-backdrop{
	    position:fixed; inset:0; display:none; place-items:center;
	    background:rgba(0,0,0,.25); z-index:50;
	  }
	  .modal-backdrop.show{ display:grid; }
	
	  .modal{
	    width:min(420px,92vw);
	    background:#fff;
	    border-radius:14px;
	    border:1px solid var(--b);
	    box-shadow:0 10px 25px rgba(0,0,0,.15);
	    padding:14px;
	  }
	
	  .modal h3{ margin:0 0 8px; font-size:1.05rem; }
	  .modal .row{ display:flex; gap:8px; margin:10px 0; }
	  .modal label{ font-size:.9rem; color:#374151; width:110px; }
	  .modal select,.modal textarea{
	    flex:1; width:100%;
	    border:1px solid var(--b);
	    border-radius:8px;
	    padding:.4rem .5rem;
	  }
	  .modal textarea{ min-height:70px; resize:vertical; }
	
	  .modal .actions{
	    display:flex; justify-content:flex-end;
	    gap:8px; margin-top:10px;
	  }
  </style>
</head>

<body>
  	<!-- Navbar -->
	<div th:if="${koadernoAktiboa != null}"
	     th:replace="irakasleak/fragments/irakasle-navbar :: navbar(${koadernoAktiboa}, ${irakasleKoadernoAktiboak})">
	</div>

  <div class="page">
    <div class="topbar">
      <h1 th:text="${koadernoa != null ? koadernoa.izena + ' — Ikasleak' : 'Ikasleak'}">Ikasleak</h1>
      <span class="badge" th:text="${kop} + ' ikasle'">0 ikasle</span>
    </div>

    <div th:if="${#lists.isEmpty(matrikulak)}" style="color:#6b7280;">
	  <p>Ez dago ikasle matrikulaturik koaderno honetan oraindik.</p>
	
	  <p style="margin:.25rem 0 0">
	    Taldean dauden ikasle kopurua:
	    <strong th:text="${taldeIkasleKop != null ? taldeIkasleKop : 0}">0</strong>
	  </p>
	
	  <form th:if="${taldeIkasleKop != null and taldeIkasleKop > 0}"
	        th:action="@{/irakasle/koadernoa/{id}/inportatu-taldetik(id=${koadernoa.id})}"
	        method="post"
	        style="margin-top:.5rem"
	        onsubmit="return confirm('Taldeko ikasle guztiak matrikulatu koaderno honetan?');">
	    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
	    <button type="submit" style="background:#2563eb;color:#fff;border:none;border-radius:.5rem;padding:.5rem .8rem;cursor:pointer;">
	      Inportatu taldeko ikasleak
	    </button>
	  </form>
	</div>

   <div class="grid" th:if="${!#lists.isEmpty(matrikulak)}">
	  <div class="card"
	       th:each="m : ${matrikulak}"
	       th:attr="data-matrikula-id=${m.id}, data-egoera=${m.egoera}">
	
	    <!-- Egoera botoia (goiko eskuinean) -->
	    <button class="status-btn"
	            type="button"
	            th:attr="data-matrikula-id=${m.id}, data-egoera=${m.egoera}, data-oharra=${m.oharra!=null?m.oharra:''}">
	      Egoera
	    </button>
	
	    <!-- Irudia + beheko banda (egoera testua) -->
	    <div class="media">
	      <img class="ph"
	           th:src="${#strings.isEmpty(m.ikaslea.argazkiPath) ? '/img/avatar-user.svg' : m.ikaslea.argazkiPath}"
	           alt="argazkia">
	      <div class="status-ribbon"
	           th:attr="data-egoera=${m.egoera}"
	           th:text="${m.egoera}">MATRIKULATUA</div>
	    </div>
	
	    <!-- Testuak -->
	    <div class="meta">
	      <div class="surnames"
	           th:text="${(m.ikaslea.abizena1?:'') + (m.ikaslea.abizena2!=null && !#strings.isEmpty(m.ikaslea.abizena2) ? ' ' + m.ikaslea.abizena2 : '')}">
	        Abizena1 Abizena2
	      </div>
	      <div class="name" th:text="${m.ikaslea.izena}">Izena</div>
	      <div class="idline">
	        <span th:text="${m.ikaslea.hna}">HNA</span>
	        <span th:if="${m.ikaslea.nan != null and !#strings.isEmpty(m.ikaslea.nan)}"
	              th:text="' · ' + ${m.ikaslea.nan}"> · NAN</span>
	      </div>
	    </div>
	  </div>
	</div>

  </div>
  
  <!-- CSRF meta-ak jada dituzu head-ean -->
<div id="egoeraModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="egoeraTitulua">
    <h3 id="egoeraTitulua">Matrikula egoera aldatu</h3>

    <div class="row">
      <label for="egoeraSelect">Egoera</label>
      <select id="egoeraSelect">
        <option th:each="ego : ${T(com.koadernoa.app.objektuak.modulua.entitateak.MatrikulaEgoera).values()}"
                th:value="${ego}" th:text="${ego}">MATRIKULATUA</option>
      </select>
    </div>

    <div class="row">
      <label for="oharraTextarea">Oharra</label>
      <textarea id="oharraTextarea" placeholder="(aukerakoa) arrazoi laburra..."></textarea>
    </div>

    <div class="actions">
      <button class="btn" type="button" id="egoeraCancelBtn">Utzi</button>
      <button class="btn primary" type="button" id="egoeraSaveBtn">Gorde</button>
    </div>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('egoeraModal');
  const select = document.getElementById('egoeraSelect');
  const oharraTx = document.getElementById('oharraTextarea');
  const cancelBtn = document.getElementById('egoeraCancelBtn');
  const saveBtn = document.getElementById('egoeraSaveBtn');

  let currentCard = null;
  let currentId = null;

  // CSRF
  const csrfToken = document.querySelector('meta[name="_csrf"]')?.content || '';
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

  // Ireki modala
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.status-btn');
    if(!btn) return;

    currentId = btn.dataset.matrikulaId;
    currentCard = btn.closest('.card');

    // Hasierako balioak
    select.value = btn.dataset.egoera || currentCard?.dataset.egoera || 'MATRIKULATUA';
    oharraTx.value = btn.dataset.oharra || '';

    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
  });

  // Itxi modala
  function closeModal(){
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
    currentCard = null;
    currentId = null;
  }
  cancelBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

  // Gorde
  saveBtn.addEventListener('click', async ()=>{
    if(!currentId) return;

    const body = new URLSearchParams();
    body.append('egoera', select.value);
    body.append('oharra', oharraTx.value || '');

    try {
      // BIDE EGOKIA: /irakasle/ikasleak/...
      const res = await fetch(`/irakasle/ikasleak/matrikula/${currentId}/egoera`, {
        method:'POST',
        headers:{
          'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8',
          [csrfHeader]: csrfToken
        },
        body
      });

      if(!res.ok){
        const text = await res.text();
        throw new Error(`HTTP ${res.status} – ${text.slice(0,120)}`);
      }

      const json = await res.json();
      if(!json || json.ok !== true){
        const msg = (json && json.msg) ? json.msg : 'Errore ezezaguna (JSON gabe edo ok=false)';
        throw new Error(msg);
      }

      // DOM eguneratu
      if(currentCard){
        currentCard.dataset.egoera = json.egoera;

        const ribbon = currentCard.querySelector('.status-ribbon');
        if(ribbon){
          ribbon.dataset.egoera = json.egoera;
          ribbon.textContent = json.egoera;
        }

        const btn = currentCard.querySelector('.status-btn');
        if(btn){
          btn.dataset.egoera = json.egoera;
          btn.dataset.oharra = json.oharra || '';
        }
      }

      closeModal();
    } catch(err){
      alert('Ezin izan da egoera gorde: ' + err.message);
    }
  });
})();
</script>

</body>
</html>
