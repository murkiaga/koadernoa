<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="eu">
<head>
  <meta charset="UTF-8">
  <title>Programazioa</title>
  <link rel="stylesheet" th:href="@{/css/irakasle-navbar.css}">
  
  <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
  <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : 'X-XSRF-TOKEN'}"/>
  <meta name="koaderno-id" th:content="${koadernoAktiboa != null ? koadernoAktiboa.id : ''}">
   
  <!-- SortableJS (d&d) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --text:#111827; --line:#e5e7eb;
      --primary:#2563eb; --primary-600:#1d4ed8;
    }
    body{background:var(--bg); color:var(--text);}
    .stack{display:grid; gap:1rem;}
    .container{max-width:1000px; margin:1rem auto; padding:0 1rem;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.04);}
    .card-header{display:flex; align-items:center; gap:.75rem; padding:1rem 1rem; border-bottom:1px solid var(--line);}
    .card-body{padding:.75rem 1rem 1rem;}
    .muted{color:var(--muted); font-size:.95rem;}

    /* UD akordeoia */
    .ud-list{display:grid; gap:.5rem; list-style:none; padding:0; margin:0;}
    .ud-item{background:#fff; border:1px solid var(--line); border-radius:12px; overflow:hidden;}
    .ud-header{display:grid; grid-template-columns: 24px 24px 1fr auto; align-items:center; gap:.5rem; padding:.8rem 1rem; cursor:pointer;}
    .handle{cursor:grab; opacity:.7;}
    .caret{transition:transform .2s ease;}
    .ud-item.open .caret{transform:rotate(90deg);}
    .ud-title{font-weight:600;}
    .ud-hours{color:var(--muted); margin-left:.5rem;}

    .ud-actions{display:flex; gap:.5rem;}
    .btn{display:inline-flex; align-items:center; gap:.4rem; padding:.45rem .7rem; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer;}
    .btn:hover{background:#f9fafb;}
    .btn-primary{background:var(--primary); color:#fff; border-color:var(--primary);}
    .btn-primary:hover{background:var(--primary-600);}
    .btn-primary:focus{outline:2px solid #93c5fd;outline-offset:2px;}
    .btn-ghost{background:transparent;}
    .badge{font-size:.85rem; color:var(--muted)}
    .add-row{display:flex; justify-content:center; padding:.8rem;}

    /* Jarduera zerrenda */
    .jp-list{display:grid; gap:.4rem; list-style:none; margin:0; padding:.5rem 0 0 0;}
    .jp-item{background:#fff; border:1px dashed var(--line); border-radius:10px; padding:.55rem .7rem; display:grid; grid-template-columns:24px 1fr auto; align-items:center; gap:.5rem;}
    .jp-title{font-weight:500;}
    .jp-hours{color:var(--muted); margin-left:.5rem;}

    /* Modal (native <dialog>) */
    dialog.modal{border:none; border-radius:16px; width:min(560px, 92vw); padding:0; box-shadow:0 20px 60px rgba(0,0,0,.25);}
    .modal header{padding:1rem 1.2rem; border-bottom:1px solid var(--line); font-weight:700;}
    .modal .content{padding:1rem 1.2rem; display:grid; gap:.8rem;}
    .modal .actions{padding:1rem 1.2rem; display:flex; gap:.6rem; justify-content:flex-end; border-top:1px solid var(--line);}
    .field{display:grid; gap:.3rem;}
    .field label{font-size:.9rem; color:var(--muted);}
    .field input[type="text"], .field input[type="number"]{padding:.55rem .7rem; border:1px solid var(--line); border-radius:10px; width:100%;}

	.btn-danger{ background:#dc2626; color:#fff; border-color:#dc2626; }
	.btn-danger:hover{ background:#b91c1c; }
  </style>
</head>
<body>
  <div th:if="${koadernoAktiboa != null}"
       th:replace="irakasleak/fragments/irakasle-navbar :: navbar(${koadernoAktiboa}, ${irakasleKoadernoAktiboak})"></div>

  <main class="container stack">
    <div class="card">
      <div class="card-header">
        <div>
          <h1 style="margin:0;">Programazioa</h1>
          <div class="muted" th:text="'Koadernoa: ' + ${koadernoAktiboa != null ? koadernoAktiboa.izena : '—'}"></div>
        </div>
        <div style="margin-left:auto; display:flex; gap:.5rem;">
          <button id="btn-open-add-ud" class="btn btn-primary">+ UD berria</button>
        </div>
      </div>

      <div class="card-body">
		  <!-- UDen zerrenda + akordeoi + d&d -->
		  <ul id="udList" class="ud-list">
		    <li class="ud-item" th:each="ud : ${unitateak}" th:attr="data-ud-id=${ud.id}">
		      <div class="ud-header" onclick="toggleUd(this)">
		        <span class="handle" title="Arrastatu ordena aldatzeko">≡</span>
		        <span class="caret">›</span>
		
		        <div>
		          <span class="ud-title" th:text="|${ud.kodea} — ${ud.izenburua}|">UD1 — Izenburua</span>
		          <!-- (UD orduak) (Σ jardueretan) -->
		          <span class="ud-hours"
		                th:text="|(${ud.orduak}h) (${jpOrduakMap[ud.id] ?: 0}h jardueretan)|">
		            (10h) (6h jardueretan)
		          </span>
		        </div>
		
		        <div class="ud-actions" onclick="event.stopPropagation()">
		          <button class="btn" th:attr="data-ud-id=${ud.id}" onclick="openUdEdit(this)">Editatu</button>
		        </div>
		      </div>
		
		      <div class="ud-content" style="display:none; padding:.4rem 1rem 1rem;">
		        <ul class="jp-list" th:attr="data-ud-id=${ud.id}">
		          <li class="jp-item" th:each="jp : ${ud.azpiJarduerak}" th:attr="data-jp-id=${jp.id}">
		            <span class="handle" title="Arrastatu ordena aldatzeko">≡</span>
		            <div>
		              <span class="jp-title" th:text="${jp.izenburua}">Jarduera</span>
		              <span class="jp-hours" th:text="|(${jp.orduak}h)|">(0h)</span>
		            </div>
		            <div class="ud-actions">
		              <button class="btn" th:attr="data-jp-id=${jp.id}" onclick="openJpEdit(this)">Editatu</button>
		            </div>
		          </li>
		        </ul>
		
		        <div class="add-row">
		          <button class="btn btn-primary" th:attr="data-ud-id=${ud.id}" onclick="openJpAdd(this)">
		            + Jarduera berria
		          </button>
		        </div>
		      </div>
		    </li>
		  </ul>
		</div>

    </div>
  </main>

  <!-- MODAL: UD sortu/edita -->
  <dialog id="udModal" class="modal">
    <form method="dialog" id="udModalForm">
		<input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <header>UDa</header>
      <div class="content">
        <input type="hidden" id="udId">
        <div class="field">
          <label>Kodea</label>
          <input type="text" id="udKodea" required>
        </div>
        <div class="field">
          <label>Izenburua</label>
          <input type="text" id="udIzenburua" required>
        </div>
        <div class="field">
          <label>Orduak (h)</label>
          <input type="number" id="udOrduak" min="0" step="1" value="0">
        </div>
      </div>
      <div class="actions">
		<button id="udDeleteBtn" class="btn btn-danger" type="button" style="margin-right:auto; display:none;">
    		Ezabatu UD
  		</button>
        <button class="btn" type="button" onclick="closeUdModal()">Utzi</button>
        <button class="btn btn-primary" type="submit">Gorde</button>
      </div>
    </form>
  </dialog>

  <!-- MODAL: Jarduera sortu/edita -->
  <dialog id="jpModal" class="modal">
    <form method="dialog" id="jpModalForm">
		<input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <header>Jarduera</header>
      <div class="content">
        <input type="hidden" id="jpId">
        <input type="hidden" id="jpUdId">
        <div class="field">
          <label>Izenburua</label>
          <input type="text" id="jpIzenburua" required>
        </div>
        <div class="field">
          <label>Orduak (h)</label>
          <input type="number" id="jpOrduak" min="0" step="1" value="0">
        </div>
      </div>
      <div class="actions">
		 <button id="jpDeleteBtn" class="btn btn-danger" type="button" style="margin-right:auto; display:none;">
    		Ezabatu jarduera
  		</button>
        <button class="btn" type="button" onclick="closeJpModal()">Utzi</button>
        <button class="btn btn-primary" type="submit">Gorde</button>
      </div>
    </form>
  </dialog>

  <script>
  // ---------- CSRF helpers ----------
  function getCookie(name){
    const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]*)'));
    return m ? decodeURIComponent(m[2]) : '';
  }

  // Meta-tik (Thymeleaf-ek injektatua) edo cookie-tik (CookieCsrfTokenRepository)
  const metaToken  = document.querySelector('meta[name="_csrf"]')?.content || '';
  const metaHeader = document.querySelector('meta[name="_csrf_header"]')?.content || '';
  const cookieToken = getCookie('XSRF-TOKEN'); // CookieCsrfTokenRepository.withHttpOnlyFalse()
  
  const KOADERNO_ID = document.querySelector('meta[name="koaderno-id"]')?.content || '';

  // Aukeratu tokena eta header egokia
  const CSRF_TOKEN  = metaToken || cookieToken || '';
  const CSRF_HEADER = metaToken ? (metaHeader || 'X-CSRF-TOKEN')
                                : (cookieToken ? 'X-XSRF-TOKEN' : '');

  // Fetch JSON laguntzailea (CSRF automatikoa + session cookie-ak)
  const fjson = (url, method, body) => fetch(url, {
    method,
    credentials: 'same-origin',
    headers: Object.assign(
      { 'Content-Type': 'application/json' },
      CSRF_TOKEN ? { [CSRF_HEADER]: CSRF_TOKEN } : {}
    ),
    body: body ? JSON.stringify(body) : undefined
  }).then(r => {
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const ct = r.headers.get('content-type') || '';
    return ct.includes('application/json') ? r.json() : { ok: true };
  }).catch(e => {
    console.error(e);
    alert('Errorea: ' + e.message);
    throw e;
  });

  // ---------- accordion ----------
  function toggleUd(el) {
    const item = el.closest('.ud-item');
    item.classList.toggle('open');
    const content = item.querySelector('.ud-content');
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
  }

  // ---------- modal: UD ----------
  const udModal = document.getElementById('udModal');
  const udForm  = document.getElementById('udModalForm');

  document.getElementById('btn-open-add-ud').addEventListener('click', () => {
    udForm.reset();
    document.getElementById('udId').value = '';
    udDeleteBtn.style.display = 'none';
    udModal.showModal();
  });
  
  // ---- UD modal: delete toggle + action
  const udDeleteBtn = document.getElementById('udDeleteBtn');

  function openUdEdit(btn){
    const id = btn.getAttribute('data-ud-id');
    fjson(`/irakasle/programazioa/api/ud/${id}`, 'GET').then(d=>{
      document.getElementById('udId').value = d.id;
      document.getElementById('udKodea').value = d.kodea;
      document.getElementById('udIzenburua').value = d.izenburua;
      document.getElementById('udOrduak').value = d.orduak ?? 0;
      
      // Edit mode -> erakutsi "Ezabatu UD"
      udDeleteBtn.style.display = 'inline-flex';
      udDeleteBtn.onclick = () => {
        if (confirm('Ziur zaude UD hau (eta bere jarduera guztiak) ezabatu nahi dituzula?')) {
          fjson(`/irakasle/programazioa/api/ud/${d.id}`, 'DELETE').then(()=>location.reload());
        }
      };
      
      udModal.showModal();
    });
  }
  function closeUdModal(){ udModal.close(); }

  udForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const payload = {
      id: document.getElementById('udId').value || null,
      kodea: document.getElementById('udKodea').value,
      izenburua: document.getElementById('udIzenburua').value,
      orduak: parseInt(document.getElementById('udOrduak').value || '0', 10)
    };
    const url = payload.id ? `/irakasle/programazioa/api/ud/${payload.id}` : `/irakasle/programazioa/api/ud`;
    const method = payload.id ? 'PUT' : 'POST';
    fjson(url, method, payload).then(()=>location.reload());
  });

  // ---------- modal: JP ----------
  const jpModal = document.getElementById('jpModal');
  const jpForm  = document.getElementById('jpModalForm');

  function openJpAdd(btn){
    jpForm.reset();
    document.getElementById('jpId').value = '';
    document.getElementById('jpUdId').value = btn.getAttribute('data-ud-id');
    jpDeleteBtn.style.display = 'none'; // berria -> ezabatu ez
    jpModal.showModal();
  }
  function openJpEdit(btn){
    const id = btn.getAttribute('data-jp-id');
    fjson(`/irakasle/programazioa/api/jp/${id}`, 'GET').then(d=>{
      document.getElementById('jpId').value = d.id;
      document.getElementById('jpUdId').value = d.udId;
      document.getElementById('jpIzenburua').value = d.izenburua;
      document.getElementById('jpOrduak').value = d.orduak ?? 0;

      jpDeleteBtn.style.display = 'inline-flex';
      jpDeleteBtn.onclick = () => {
        if (confirm('Ziur zaude jarduera hau ezabatu nahi duzula?')) {
          fjson(`/irakasle/programazioa/api/jp/${d.id}`, 'DELETE').then(()=>location.reload());
        }
      };

      jpModal.showModal();
    });
  }
  function closeJpModal(){ jpModal.close(); }

  jpForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const id = document.getElementById('jpId').value;
    const payload = {
      udId: parseInt(document.getElementById('jpUdId').value, 10),
      izenburua: document.getElementById('jpIzenburua').value,
      orduak: parseInt(document.getElementById('jpOrduak').value || '0', 10)
    };
    const url = id ? `/irakasle/programazioa/api/jp/${id}` : `/irakasle/programazioa/api/jp`;
    const method = id ? 'PUT' : 'POST';
    fjson(url, method, id ? payload : { ...payload }).then(()=>location.reload());
  });

  // ---------- d&d: UD ordena ----------
  new Sortable(document.getElementById('udList'), {
    handle: '.handle',
    animation: 150,
    onEnd: () => {
      const ids = [...document.querySelectorAll('#udList .ud-item')].map(li => parseInt(li.getAttribute('data-ud-id')));
      fjson('/irakasle/programazioa/api/ud/ordenatu', 'POST', { udIds: ids });
    }
  });

  // ---------- d&d: JP (kross-UD mugimendua ere bai) ----------
  document.querySelectorAll('.jp-list').forEach(list=>{
    new Sortable(list, {
      group: 'jp',
      handle: '.handle',
      animation: 150,
      onEnd: (evt)=>{
        const jpId = parseInt(evt.item.getAttribute('data-jp-id'));
        const toUdId = parseInt(evt.to.getAttribute('data-ud-id'));
        const newIndex = evt.newIndex;
        fjson('/irakasle/programazioa/api/jp/mugitu', 'POST', { jpId, toUdId, newIndex });
      }
    });
  });
</script>

</body>
</html>
