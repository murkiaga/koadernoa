<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="eu">
<head>
  <meta charset="UTF-8">
  <title>Programazioa</title>
  <link rel="stylesheet" th:href="@{/css/irakasle-navbar.css}">
  <link rel="stylesheet" th:href="@{/css/irakasle-common.css}">
  
  <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
  <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : 'X-XSRF-TOKEN'}"/>
  <meta name="koaderno-id" th:content="${koadernoAktiboa != null ? koadernoAktiboa.id : ''}">
   
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  
  <style>
    :root{
      --bg:#f6f7fb;
    }
    body{ background:var(--bg); }

    .container{
      max-width:1200px;
      width:80%;
      margin:1rem auto;
      padding:0 1rem 2rem;
    }

    .stack{display:grid; gap:1rem;}

    /* .card oinarria commons-etik, hemen gainidaztuta header/body */
    .card{
      border-radius:14px;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }
    .card-header{
      display:flex;
      align-items:center;
      gap:.75rem;
      padding:1rem 1rem;
      border-bottom:1px solid var(--b);
    }
    .card-body{
      padding:.75rem 1rem 1rem;
    }

    .muted{color:var(--muted); font-size:.95rem;}

    .ebal-list, .ud-list, .jp-list{
      display:grid;
      gap:.5rem;
      list-style:none;
      padding:0;
      margin:0;
    }
    .ebal-item, .ud-item{
      background:#fff;
      border:1px solid var(--b);
      border-radius:12px;
      overflow:hidden;
    }
    .ebal-header, .ud-header{
      display:grid;
      grid-template-columns: 24px 1fr auto;
      align-items:center;
      gap:.5rem;
      padding:.8rem 1rem;
      cursor:pointer;
    }
    .caret{transition:transform .2s ease;}
    .ebal-item.open > .ebal-header .caret,
    .ud-item.open   > .ud-header   .caret{transform:rotate(90deg);}
    .handle{cursor:grab; opacity:.7;}
    .title{font-weight:700;}
    .badge{font-size:.85rem; color:var(--muted)}
    .hours-warn{color:#b91c1c; font-weight:600;}

    .actions{display:flex; gap:.5rem;}

    .btn-ghost{background:transparent;}

    .add-row{
      display:flex;
      justify-content:center;
      padding:.8rem;
    }

    .jp-list{gap:.4rem; margin:0; padding:.5rem 0 0 0;}
    .jp-item{
      background:#fff;
      border:1px dashed var(--b);
      border-radius:10px;
      padding:.55rem .7rem;
      display:grid;
      grid-template-columns:24px 1fr auto;
      align-items:center;
      gap:.5rem;
    }
    .jp-title{font-weight:500;}
    .jp-hours{color:var(--muted); margin-left:.5rem;}

    .txantiloi-taula{
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
    }
    .txantiloi-taula th,
    .txantiloi-taula td{
      border:1px solid var(--b);
      padding:.5rem;
      text-align:left;
    }
    .txantiloi-taula th{
      background:#f3f4f6;
      font-weight:600;
    }
    .txantiloi-taula tbody tr:nth-child(odd){
      background:#fff;
    }

    /* Modal <dialog> */
    dialog.modal{
      border:none;
      border-radius:16px;
      width:min(560px, 92vw);
      padding:0;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
    }
    .modal header{
      padding:1rem 1.2rem;
      border-bottom:1px solid var(--b);
      font-weight:700;
    }
    .modal .content{
      padding:1rem 1.2rem;
      display:grid;
      gap:.8rem;
    }
    .modal .actions{
      padding:1rem 1.2rem;
      display:flex;
      gap:.6rem;
      justify-content:flex-end;
      border-top:1px solid var(--b);
    }
    .field{display:grid; gap:.3rem;}
    .field label{font-size:.9rem; color:var(--muted);}
    .field input[type="text"],
    .field input[type="number"],
    .field input[type="date"]{
      padding:.55rem .7rem;
      border:1px solid var(--b);
      border-radius:10px;
      width:100%;
    }

  	/* Ebaluaketa koloreak */
	  /* Ebaluaketa koloreak: ebaluazio beraren “kolorea” erabili */
	.ebal-item.color-1 {background-color: var(--ebal1-color);border-left: 6px solid var(--ebal1-color);}
	.ebal-item.color-2 {background-color: var(--ebal2-color);border-left: 6px solid var(--ebal2-color);}
	.ebal-item.color-3 {background-color: var(--ebal3-color);border-left: 6px solid var(--ebal3-color);}
	
	/* 4,5,6 erabiliz gero, nahi duzun logika:
	   - errepikatu patroia edo
	   - beste kolore “sekundario” batzuk eskuz */
	.ebal-item.color-4 {background-color: var(--ebal1-color);border-left: 6px solid var(--ebal1-color);}
	.ebal-item.color-5 {background-color: var(--ebal2-color);border-left: 6px solid var(--ebal2-color);}
	.ebal-item.color-6 {background-color: var(--ebal3-color);border-left: 6px solid var(--ebal3-color);}
	  
	  /* Bolkatu egunerokora botoiak */
	  .btn-icon{
		  padding: .3rem .4rem;
		  border-radius: 5px;
		  display:inline-flex;
		  align-items:center;
		  justify-content:center;
		}
		
		.btn-icon:hover{
		  background:#f3f4f6;
		}
		
		.btn-icon .bulkatu-eb-ikonoa{
		  width: 40px;
		  height: 20px;
		  display:block;
		}

	  .actions-bottom{
	    display:flex;
	    justify-content:flex-end;
	    gap:.5rem;
	    margin-top:1rem;
	  }
	
	  .ebal-edit-btn{
	    display:none;
	  }
	  .edit-mode .ebal-edit-btn{
	    display:inline-flex;
	  }
  </style>
</head>

<body>
  <div th:if="${koadernoAktiboa != null}"
       th:replace="~{irakasleak/fragments/irakasle-navbar :: navbar(${koadernoAktiboa}, ${irakasleKoadernoAktiboak})}"></div>

  <main class="container stack">
    <div class="card">
      <div class="card-header">
        <div>
          <h1 style="margin:0; display:flex; align-items:baseline; gap:.5rem;">
            <span>Programazioa</span>
          </h1>
          <div class="muted"
               th:text="'Koadernoa: ' + ${koadernoAktiboa != null ? koadernoAktiboa.izena : '—'}">
          </div>
        </div>
        <div style="margin-left:auto; display:flex; gap:.5rem;">
          <button id="btn-open-add-ebal" class="btn btn-primary">+ Ebaluaketa berria</button>
          
          <!-- Programazioa inportatzeko botoia
		       soilik programazioa hutsik badago eta badago beste koadernorik -->
		      <button id="programazioaInportatuBtn"
		              class="btn"
		              th:if="${programazioaHutsik and !#lists.isEmpty(inportatzekoKoadernoak)}">
		        Programazioa inportatu
		      </button>

          <button id="txantiloiEkarriBtn"
                  class="btn"
                  th:if="${programazioaHutsik and !#lists.isEmpty(txantiloiak)}">
            Aurreko urteko denboralizaziotik ekarri
          </button>

          <div th:if="${programazioaHutsik and #lists.isEmpty(inportatzekoKoadernoak) and #lists.isEmpty(txantiloiak)}"
               class="muted">
            Ez dago beste koadernorik edo txantiloirik inportatzeko.
          </div>
        </div>
      </div>

      <div class="card-body">
        <!-- EBALUAKETA -> UD -> JP -->
        <ul id="ebalList" class="ebal-list">
		  <li th:each="eb, iter : ${ebaluaketak}"
		      th:with="colorIdx=${((iter.index) % 6) + 1}"
		      class="ebal-item"
		      th:attr="data-eb-id=${eb.id}"
		      th:classappend="| color-${colorIdx}|">
		
		    <!-- HEADER: izena, orduak, datak, botoiak -->
		    <div class="ebal-header" onclick="toggleEbal(this)">
		      <span class="caret">›</span>
		
		      <div>
		        <div class="title" th:text="${eb.izena}">1. Ebaluaketa</div>
		        <div class="badge">
		          <!-- (planifikatuta / erabilgarri) -->
		          <span th:with="planif=${ebalUdOrduak[eb.id] ?: 0},
		                         dispo=${ebalDispon[eb.id] ?: 0}"
		                th:classappend="${planif > dispo} ? ' hours-warn' : ''"
		                th:text="|(${planif}h / ${dispo}h erabilgarri)|">
		            (0h / 0h erabilgarri)
		          </span>
		          <!-- Data-mugak -->
		          <span class="badge"
		                th:text="| — ${eb.hasieraData} → ${eb.bukaeraData}|">
		            — 2025-09-10 → 2026-01-31
		          </span>
		        </div>
		      </div>
		
		      <!-- EKINTZAK (eskuineko zutabea) -->
		      <div class="actions" style="margin-left:auto" onclick="event.stopPropagation()">
		
		        <!-- EB hau denboralizaziora bolkatzeko ikono-botoia -->
		        <button class="btn btn-icon"
		                type="button"
		                th:attr="data-eb-id=${eb.id}"
		                title="Ebaluaketa hau denboralizaziora bolkatu"
		                aria-label="Ebaluaketa hau denboralizaziora bolkatu"
		                onclick="bulkatuEbaluaketa(this)">
		          <img th:src="@{/img/eb-bolkatu.png}"
		               alt="Ebaluaketa hau denboralizaziora bolkatu"
		               class="bulkatu-eb-ikonoa">
		        </button>
		
		        <!-- EB editatzeko botoia (edit-mode-n bakarrik ikusgai) -->
		        <button class="btn ebal-edit-btn"
		                type="button"
		                th:attr="data-eb-id=${eb.id}"
		                onclick="openEbalEdit(this)">
		          Editatu
		        </button>
		      </div>
		    </div>
		
		    <!-- EDUKIA: EB barruko UD-ak + "+UD berria" botoia -->
		    <div class="ebal-content" style="display:none; padding:.4rem 1rem 1rem;">
		      <!-- EB barruko UD-ak -->
		      <ul class="ud-list" th:attr="data-eb-id=${eb.id}">
		        <li class="ud-item"
		            th:each="ud : ${eb.unitateak}"
		            th:attr="data-ud-id=${ud.id}">
		          <div class="ud-header" onclick="toggleUd(this)">
		            <span class="handle" title="Arrastatu ordena aldatzeko">≡</span>
		            <div>
		              <span class="title"
		                    th:text="|${ud.kodea} — ${ud.izenburua}|">
		                UD1 — Izenburua
		              </span>
		              <span class="badge"
		                    th:with="jp=${jpOrduakMap[ud.id] ?: 0}"
		                    th:text="|(${ud.orduak}h) (jardueretan ${jp}h)|">
		                (0h) (jardueretan 0h)
		              </span>
		            </div>
		            <div class="actions" style="margin-left:auto" onclick="event.stopPropagation()">
		              <button class="btn"
		                      th:attr="data-ud-id=${ud.id}"
		                      onclick="openUdEdit(this)">
		                Editatu
		              </button>
		            </div>
		          </div>
		
		          <div class="ud-content" style="display:none; padding:.4rem 1rem 1rem;">
		            <ul class="jp-list" th:attr="data-ud-id=${ud.id}">
		              <li class="jp-item"
		                  th:each="jp : ${ud.azpiJarduerak}"
		                  th:attr="data-jp-id=${jp.id}">
		                <span class="handle" title="Arrastatu ordena aldatzeko">≡</span>
		                <div>
		                  <span class="jp-title" th:text="${jp.izenburua}">Jarduera</span>
		                  <span class="jp-hours" th:text="|(${jp.orduak}h)|">(0h)</span>
		                </div>
		                <div class="actions">
		                  <button class="btn"
		                          th:attr="data-jp-id=${jp.id}"
		                          onclick="openJpEdit(this)">
		                    Editatu
		                  </button>
		                </div>
		              </li>
		            </ul>
		
		            <div class="add-row">
		              <button class="btn btn-primary"
		                      th:attr="data-ud-id=${ud.id}"
		                      onclick="openJpAdd(this)">
		                + Jarduera berria
		              </button>
		            </div>
		          </div>
		        </li>
		      </ul>
		
		      <!-- EB honetan UD berria gehitzeko botoia -->
		      <div class="add-row">
		        <button class="btn btn-primary"
		                th:attr="data-eb-id=${eb.id}"
		                onclick="openUdAdd(this)">
		          + UD berria ebaluazio honetan
		        </button>
		      </div>
		    </div>
		  </li>
		</ul>
      </div>
    </div>

    <!-- Denboralizaziora bolkatu --> 
    <!-- Beheko botoiak: edit modu orokorra + bolkatzea -->
	<div class="actions actions-bottom">
	  <button id="toggleEbalEditBtn" class="btn" type="button">
	    Ebaluazioak editatu
	  </button>
	
	  <button id="btnPreviewBulk" class="btn btn-primary"
	          th:attr="data-koaderno-id=${koadernoAktiboa.id}"
	          th:disabled="${!canBulk}">
	    Denboralizaziora bolkatu
	  </button>
	</div>
    <div th:if="${!canBulk}" class="alert alert-warning mt-2">
      Ezin da bolkatu: egutegia/ordutegia/programazioa osatu gabe.
    </div>
  </main>

  <!-- MODAL: Ebaluaketa sortu/edita -->
  <dialog id="ebalModal" class="modal">
    <form method="dialog" id="ebalModalForm">
      <input type="hidden"
             th:if="${_csrf != null}"
             th:name="${_csrf.parameterName}"
             th:value="${_csrf.token}"/>
      <header>Ebaluaketa</header>
      <div class="content">
        <input type="hidden" id="ebalId">
        <div class="field">
          <label>Izena</label>
          <input type="text" id="ebalIzena" placeholder="1. Ebaluaketa" required>
        </div>
        <div class="field">
          <label>Hasiera data</label>
          <input type="date" id="ebalHasiera">
        </div>
        <div class="field">
          <label>Bukaera data</label>
          <input type="date" id="ebalBukaera">
        </div>
      </div>
      <div class="actions">
        <button id="ebalDeleteBtn"
                class="btn btn-danger"
                type="button"
                style="margin-right:auto; display:none;">
          Ezabatu ebaluaketa
        </button>
        <button class="btn" type="button" onclick="closeEbalModal()">Utzi</button>
        <button class="btn btn-primary" type="submit">Gorde</button>
      </div>
    </form>
  </dialog>

  <!-- MODAL: UD sortu/edita -->
  <dialog id="udModal" class="modal">
    <form method="dialog" id="udModalForm">
      <input type="hidden"
             th:if="${_csrf != null}"
             th:name="${_csrf.parameterName}"
             th:value="${_csrf.token}"/>
      <header>UDa</header>
      <div class="content">
        <input type="hidden" id="udId">
        <input type="hidden" id="udEbalId">
        <div class="field">
          <label>Kodea</label>
          <input type="text" id="udKodea" required>
        </div>
        <div class="field">
          <label>Izenburua</label>
          <input type="text" id="udIzenburua" required>
        </div>
        <div class="field">
          <label>Orduak (h)</label>
          <input type="number" id="udOrduak" min="0" step="1" value="0">
        </div>
      </div>
      <div class="actions">
        <button id="udDeleteBtn"
                class="btn btn-danger"
                type="button"
                style="margin-right:auto; display:none;">
          Ezabatu UD
        </button>
        <button class="btn" type="button" onclick="closeUdModal()">Utzi</button>
        <button class="btn btn-primary" type="submit">Gorde</button>
      </div>
    </form>
  </dialog>

  <!-- MODAL: Jarduera sortu/edita -->
  <dialog id="jpModal" class="modal">
    <form method="dialog" id="jpModalForm">
      <input type="hidden"
             th:if="${_csrf != null}"
             th:name="${_csrf.parameterName}"
             th:value="${_csrf.token}"/>
      <header>Jarduera</header>
      <div class="content">
        <input type="hidden" id="jpId">
        <input type="hidden" id="jpUdId">
        <div class="field">
          <label>Izenburua</label>
          <input type="text" id="jpIzenburua" required>
        </div>
        <div class="field">
          <label>Orduak (h)</label>
          <input type="number" id="jpOrduak" min="0" step="1" value="0">
        </div>
      </div>
      <div class="actions">
        <button id="jpDeleteBtn"
                class="btn btn-danger"
                type="button"
                style="margin-right:auto; display:none;">
          Ezabatu jarduera
        </button>
        <button class="btn" type="button" onclick="closeJpModal()">Utzi</button>
        <button class="btn btn-primary" type="submit">Gorde</button>
      </div>
    </form>
  </dialog>
  
  <!-- Programazioa inportatzeko modala (fragment-a) -->
  <div th:replace="~{irakasleak/programazioa/programazioa-inport-modala :: programazioa-inport-modal}"></div>

  <dialog id="txantiloiModal" class="modal" th:if="${programazioaHutsik and !#lists.isEmpty(txantiloiak)}">
    <header>Txantiloia aukeratu</header>
    <div class="content">
      <div class="muted">Aurreko urteko denboralizaziotik ekarritako jarduerak gehitzeko.</div>
      <div class="table-responsive">
        <table class="txantiloi-taula">
          <thead>
            <tr>
              <th>Izena</th>
              <th>Sortze-data</th>
              <th>Jarduerak</th>
              <th>Guztira (min)</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="tx : ${txantiloiak}">
              <td th:text="${tx.izena}">Txantiloia</td>
              <td th:text="${#temporals.format(tx.sortzeData, 'yyyy-MM-dd HH:mm')}">2025-06-30 12:00</td>
              <td th:text="${tx.jardueraKopurua}">0</td>
              <td th:text="${tx.guztiraMin}">0</td>
              <td style="text-align:right;">
                <form method="post"
                      th:action="@{/irakasle/programazioa/txantiloiak/{id}/aplikatu(id=${tx.id})}">
                  <input type="hidden"
                         th:if="${_csrf != null}"
                         th:name="${_csrf.parameterName}"
                         th:value="${_csrf.token}"/>
                  <button type="submit" class="btn btn-primary">Aplikatu koaderno honetara</button>
                </form>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="actions">
      <button class="btn" type="button" onclick="closeTxantiloiModal()">Itxi</button>
    </div>
  </dialog>

    <!-- SCRIPT NAGUSIAK -->
  <script>
  // ---------- CSRF helpers ----------
  function getCookie(name){
    const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]*)'));
    return m ? decodeURIComponent(m[2]) : '';
  }
  const metaToken  = document.querySelector('meta[name="_csrf"]')?.content || '';
  const metaHeader = document.querySelector('meta[name="_csrf_header"]')?.content || '';
  const cookieToken = getCookie('XSRF-TOKEN');
  const KOADERNO_ID = document.querySelector('meta[name="koaderno-id"]')?.content || '';

  const CSRF_TOKEN  = metaToken || cookieToken || '';
  const CSRF_HEADER = metaToken ? (metaHeader || 'X-CSRF-TOKEN')
                                : (cookieToken ? 'X-XSRF-TOKEN' : '');

  function openTxantiloiModal() {
    const modal = document.getElementById('txantiloiModal');
    if (modal) modal.showModal();
  }

  function closeTxantiloiModal() {
    const modal = document.getElementById('txantiloiModal');
    if (modal) modal.close();
  }

  function initTxantiloiModal() {
    const btn = document.getElementById('txantiloiEkarriBtn');
    if (!btn) return;
    btn.addEventListener('click', openTxantiloiModal);
  }

  // ---------- Open state (ebal/UD irekiak gordetzeko) ----------
  const OPEN_STATE_KEY = 'programazioaOpenState_' + (KOADERNO_ID || 'default');

  function saveOpenState() {
    const openEb = Array.from(document.querySelectorAll('.ebal-item.open'))
      .map(li => li.getAttribute('data-eb-id'));

    const openUd = Array.from(document.querySelectorAll('.ud-item.open'))
      .map(li => li.getAttribute('data-ud-id'));

    const state = { eb: openEb, ud: openUd };
    try {
      localStorage.setItem(OPEN_STATE_KEY, JSON.stringify(state));
    } catch (e) {
      console.warn('Ezin izan da openState gorde', e);
    }
  }

  function restoreOpenState() {
    let raw = null;
    try {
      raw = localStorage.getItem(OPEN_STATE_KEY);
    } catch (e) {
      console.warn('Ezin izan da openState irakurri', e);
      return;
    }
    if (!raw) return;

    let state;
    try {
      state = JSON.parse(raw);
    } catch (e) {
      console.warn('openState JSON hondatuta dago', e);
      return;
    }

    if (state.eb && Array.isArray(state.eb)) {
      state.eb.forEach(id => {
        const li = document.querySelector(`.ebal-item[data-eb-id="${id}"]`);
        if (!li) return;
        li.classList.add('open');
        const content = li.querySelector('.ebal-content');
        if (content) content.style.display = 'block';
      });
    }

    if (state.ud && Array.isArray(state.ud)) {
      state.ud.forEach(id => {
        const li = document.querySelector(`.ud-item[data-ud-id="${id}"]`);
        if (!li) return;
        li.classList.add('open');
        const content = li.querySelector('.ud-content');
        if (content) content.style.display = 'block';
      });
    }
  }

  // ---------- Edit mode toggle (ebaluaketen "Editatu" botoiak erakusteko) ----------
  function initEbalEditToggle() {
    const btn = document.getElementById('toggleEbalEditBtn');
    if (!btn) return;

    let editMode = false;

    function refreshLabel() {
      btn.textContent = editMode ? 'Edizioa amaitu' : 'Ebaluazioak editatu';
    }
    refreshLabel();

    btn.addEventListener('click', () => {
      editMode = !editMode;
      document.body.classList.toggle('edit-mode', editMode);
      refreshLabel();
    });
  }

  function reloadKeepingState() {
    saveOpenState();
    window.location.reload();
  }

  // DOM kargatzean: akordeoien egoera berreskuratu + edit-toggle prestatu
  document.addEventListener('DOMContentLoaded', () => {
    restoreOpenState();
    initEbalEditToggle();
    initTxantiloiModal();
  });

  const fjson = (url, method, body) => fetch(url, {
    method,
    credentials: 'same-origin',
    headers: Object.assign(
      { 'Content-Type': 'application/json' },
      CSRF_TOKEN ? { [CSRF_HEADER]: CSRF_TOKEN } : {}
    ),
    body: body ? JSON.stringify(body) : undefined
  })
  .then(async r => {
    const ct = r.headers.get('content-type') || '';
    const isJson = ct.includes('application/json');

    let data = null;
    if (isJson) {
      try {
        data = await r.json();
      } catch (e) {
        console.warn('JSON parse errorea', e);
      }
    }

    if (!r.ok) {
      const msg =
        (data && (data.error || data.message)) ||
        ('HTTP ' + r.status);
      throw new Error(msg);
    }

    // OK bada, JSON bueltatzen badu datu hori; bestela {ok:true}
    return data ?? { ok: true };
  })
  .catch(e => {
    console.error(e);
    alert('Errorea: ' + e.message);
    throw e;
  });

  // ---------- accordion ----------
  function toggleEbal(el){
    const item = el.closest('.ebal-item');
    item.classList.toggle('open');
    const content = item.querySelector('.ebal-content');
    content.style.display = content.style.display === 'none' ? 'block' : 'none';

    saveOpenState();
  }
  function toggleUd(el){
    const item = el.closest('.ud-item');
    item.classList.toggle('open');
    const content = item.querySelector('.ud-content');
    content.style.display = content.style.display === 'none' ? 'block' : 'none';

    saveOpenState();
  }

  // ---------- Ebaluaketa modal ----------
  const ebalModal = document.getElementById('ebalModal');
  const ebalForm  = document.getElementById('ebalModalForm');
  const ebalDeleteBtn = document.getElementById('ebalDeleteBtn');

  document.getElementById('btn-open-add-ebal').addEventListener('click', () => {
    ebalForm.reset();
    document.getElementById('ebalId').value = '';
    ebalDeleteBtn.style.display = 'none';
    ebalModal.showModal();
  });

  function openEbalEdit(btn){
    const id = btn.getAttribute('data-eb-id');
    fjson(`/irakasle/programazioa/api/ebal/${id}`, 'GET').then(d=>{
      document.getElementById('ebalId').value = d.id;
      document.getElementById('ebalIzena').value = d.izena || '';
      document.getElementById('ebalHasiera').value = d.hasieraData || '';
      document.getElementById('ebalBukaera').value = d.bukaeraData || '';

      ebalDeleteBtn.style.display = 'inline-flex';
      ebalDeleteBtn.onclick = () => {
        if (confirm('Ziur zaude ebaluaketa hau (eta bere UD guztiak) ezabatu nahi dituzula?')) {
          fjson(`/irakasle/programazioa/api/ebal/${d.id}`, 'DELETE').then(()=>reloadKeepingState());
        }
      };
      ebalModal.showModal();
    });
  }
  function closeEbalModal(){ ebalModal.close(); }

  ebalForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const payload = {
      id: document.getElementById('ebalId').value || null,
      izena: document.getElementById('ebalIzena').value,
      hasieraData: document.getElementById('ebalHasiera').value || null,
      bukaeraData: document.getElementById('ebalBukaera').value || null
    };
    const url = payload.id ? `/irakasle/programazioa/api/ebal/${payload.id}` : `/irakasle/programazioa/api/ebal`;
    const method = payload.id ? 'PUT' : 'POST';
    fjson(url, method, payload).then(()=>reloadKeepingState());
  });

  // ---------- UD modal ----------
  const udModal = document.getElementById('udModal');
  const udForm  = document.getElementById('udModalForm');
  const udDeleteBtn = document.getElementById('udDeleteBtn');

  function openUdAdd(btn){
    udForm.reset();
    document.getElementById('udId').value = '';
    document.getElementById('udEbalId').value = btn.getAttribute('data-eb-id');
    udDeleteBtn.style.display = 'none';
    udModal.showModal();
  }
  function openUdEdit(btn){
    const id = btn.getAttribute('data-ud-id');
    fjson(`/irakasle/programazioa/api/ud/${id}`, 'GET').then(d=>{
      document.getElementById('udId').value = d.id;
      document.getElementById('udEbalId').value = d.ebaluaketaId;
      document.getElementById('udKodea').value = d.kodea;
      document.getElementById('udIzenburua').value = d.izenburua;
      document.getElementById('udOrduak').value = d.orduak ?? 0;

      udDeleteBtn.style.display = 'inline-flex';
      udDeleteBtn.onclick = () => {
        if (confirm('Ziur zaude UD hau (eta bere jarduera guztiak) ezabatu nahi dituzula?')) {
          fjson(`/irakasle/programazioa/api/ud/${d.id}`, 'DELETE').then(()=>reloadKeepingState());
        }
      };
      udModal.showModal();
    });
  }
  function closeUdModal(){ udModal.close(); }

  udForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const payload = {
      id: document.getElementById('udId').value || null,
      ebaluaketaId: parseInt(document.getElementById('udEbalId').value, 10),
      kodea: document.getElementById('udKodea').value,
      izenburua: document.getElementById('udIzenburua').value,
      orduak: parseInt(document.getElementById('udOrduak').value || '0', 10)
    };
    const url = payload.id ? `/irakasle/programazioa/api/ud/${payload.id}` : `/irakasle/programazioa/api/ud`;
    const method = payload.id ? 'PUT' : 'POST';
    fjson(url, method, payload).then(()=>reloadKeepingState());
  });

  // ---------- JP modal ----------
  const jpModal = document.getElementById('jpModal');
  const jpForm  = document.getElementById('jpModalForm');
  const jpDeleteBtn = document.getElementById('jpDeleteBtn');

  function openJpAdd(btn){
    jpForm.reset();
    document.getElementById('jpId').value = '';
    document.getElementById('jpUdId').value = btn.getAttribute('data-ud-id');
    jpDeleteBtn.style.display = 'none';
    jpModal.showModal();
  }
  function openJpEdit(btn){
    const id = btn.getAttribute('data-jp-id');
    fjson(`/irakasle/programazioa/api/jp/${id}`, 'GET').then(d=>{
      document.getElementById('jpId').value = d.id;
      document.getElementById('jpUdId').value = d.udId;
      document.getElementById('jpIzenburua').value = d.izenburua;
      document.getElementById('jpOrduak').value = d.orduak ?? 0;

      jpDeleteBtn.style.display = 'inline-flex';
      jpDeleteBtn.onclick = () => {
        if (confirm('Ziur zaude jarduera hau ezabatu nahi duzula?')) {
          fjson(`/irakasle/programazioa/api/jp/${d.id}`, 'DELETE').then(()=>reloadKeepingState());
        }
      };
      jpModal.showModal();
    });
  }
  function closeJpModal(){ jpModal.close(); }

  jpForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const id = document.getElementById('jpId').value;
    const payload = {
      udId: parseInt(document.getElementById('jpUdId').value, 10),
      izenburua: document.getElementById('jpIzenburua').value,
      orduak: parseInt(document.getElementById('jpOrduak').value || '0', 10)
    };
    const url = id ? `/irakasle/programazioa/api/jp/${id}` : `/irakasle/programazioa/api/jp`;
    const method = id ? 'PUT' : 'POST';
    fjson(url, method, id ? payload : { ...payload }).then(()=>reloadKeepingState());
  });

  // ---------- d&d: UD & JP (SortableJS badagoen bitartean) ----------
  if (window.Sortable) {
    document.querySelectorAll('.ud-list').forEach(list=>{
      new Sortable(list, {
        group: { name:'ud', pull:true, put:true },
        handle: '.handle',
        animation: 150,
        onEnd: (evt)=>{
          const udId = parseInt(evt.item.getAttribute('data-ud-id'));
          const toEbalId = parseInt(evt.to.getAttribute('data-eb-id'));
          const newIndex = evt.newIndex;
          fjson('/irakasle/programazioa/api/ud/mugitu', 'POST', { udId, toEbaluaketaId: toEbalId, newIndex });
        }
      });
    });

    document.querySelectorAll('.jp-list').forEach(list=>{
      new Sortable(list, {
        group: 'jp',
        handle: '.handle',
        animation: 150,
        onEnd: (evt)=>{
          const jpId = parseInt(evt.item.getAttribute('data-jp-id'));
          const toUdId = parseInt(evt.to.getAttribute('data-ud-id'));
          const newIndex = evt.newIndex;
          fjson('/irakasle/programazioa/api/jp/mugitu', 'POST', { jpId, toUdId, newIndex });
        }
      });
    });
  } else {
    console.warn('SortableJS ez dago kargatuta; d&d ezgaituta.');
  }

  // ------- Programazioa --> Denboralizazioa (aurreikuspenik gabe, zuzenean POST) -------
  (function(){
    const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    async function sendBulkRequest({ koadernoId, ebaluaketaId, replaceExisting = true }) {
      const params = new URLSearchParams();
      params.set('koadernoId', koadernoId);
      params.set('replaceExisting', String(replaceExisting));
      if (ebaluaketaId) {
        params.set('ebaluaketaId', ebaluaketaId);
      }

      const res = await fetch('/irakasle/programazioa/bolkatu', {
        method: 'POST',
        headers: {
          'Content-Type':'application/x-www-form-urlencoded',
          ...(csrfHeader && csrfToken ? { [csrfHeader]: csrfToken } : {})
        },
        body: params.toString()
      });

      if (res.redirected) {
        window.location = res.url;
        return;
      }
      if (!res.ok) {
        const txt = await res.text();
        alert(txt || 'Errorea bolkatzean.');
        return;
      }
      // OK bada eta ez badago redirect-ik:
      reloadKeepingState();
    }

    // --- Botoi nagusia: programazio osoa ---
    const btnAll = document.getElementById('btnPreviewBulk');
    if (btnAll) {
      btnAll.addEventListener('click', async () => {
        const koadernoId = btnAll.dataset.koadernoId;
        if (!koadernoId) {
          alert('Ezin da bolkatu: koadernoa ez dago zehaztuta.');
          return;
        }

        const onartu = confirm(
          'Ziur zaude programazio OSOA denboralizaziora bolkatu nahi duzula?\n' +
          'Aurreko planifikazioak gainidatzi daitezke.'
        );
        if (!onartu) return;

        try {
          await sendBulkRequest({ koadernoId });
        } catch (e) {
          console.error(e);
          alert('Errore ezustekoa bolkatzean.');
        }
      });
    }

    // --- EB bakarra bolkatzeko funtzio globala ---
    window.bulkatuEbaluaketa = async function(btn) {
      const koadernoId = document.querySelector('meta[name="koaderno-id"]')?.content;
      const ebaluaketaId = btn.dataset.ebId;     // data-eb-id -> dataset.ebId

      if (!koadernoId || !ebaluaketaId) {
        alert('Datuak falta dira (koadernoId edo ebaluaketaId).');
        return;
      }

      const onartu = confirm(
        'Ziur zaude EBALUAKETA HAU BAKARRIK denboralizaziora bolkatu nahi duzula?\n' +
        'Ebaluaketa honetako jardueren planifikazioa gainidatz daiteke.'
      );
      if (!onartu) return;

      try {
        await sendBulkRequest({ koadernoId, ebaluaketaId });
      } catch (e) {
        console.error(e);
        alert('Errore ezustekoa bolkatzean.');
      }
    };
  })();

  // ------- "Programazioa inportatu" modala -------
  (function(){
    const openBtn   = document.getElementById('programazioaInportatuBtn');
    const overlay   = document.getElementById('programazioaImportModal');
    if (!openBtn || !overlay) {
      // Botoia ez badago (programazioa ez bada hutsik, adib.), ez dugu ezer egiten
      return;
    }

    const closeBtn   = overlay.querySelector('#modalCloseBtn');
    const previewBox = document.getElementById('aurreikuspenEdukia');
    const inportForm = document.getElementById('inportatuForm');
    const iturburuaInput = document.getElementById('iturburuaId');

    function openModal() {
      overlay.classList.add('show');
    }
    function closeModal() {
      overlay.classList.remove('show');
    }

    openBtn.addEventListener('click', openModal);
    closeBtn?.addEventListener('click', closeModal);
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeModal();
    });

    // Aurreikusi botoiak
    overlay.querySelectorAll('.aurreikusi-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        if (!id || !previewBox) return;

        try {
          const res = await fetch(`/irakasle/programazioa/aurreikusi/${id}`, {
            headers: { 'X-Requested-With':'XMLHttpRequest' }
          });
          const html = await res.text();
          previewBox.innerHTML = html;
        } catch (err) {
          console.error(err);
          previewBox.innerHTML =
            '<p style="color:#b91c1c;font-size:0.9rem;">Errorea aurreikuspena kargatzean.</p>';
        }
      });
    });

    // Inportatu botoiak
    overlay.querySelectorAll('.inportatu-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        if (!id || !inportForm || !iturburuaInput) return;

        const onartu = confirm(
          'Ziur zaude koaderno honen programazioa inportatu nahi duzula?\n' +
          'Oraingo programazioa gainidatzi daiteke.'
        );
        if (!onartu) return;

        iturburuaInput.value = id;
        inportForm.submit(); // HTML form-ak berak eramango du CSRF barne
      });
    });
  })();
  </script>



</body>
</html>
