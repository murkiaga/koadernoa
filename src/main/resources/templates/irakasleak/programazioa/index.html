<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="eu">
<head>
  <meta charset="UTF-8">
  <title>Programazioa</title>
  <link rel="stylesheet" th:href="@{/css/irakasle-navbar.css}">
  
  <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
  <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : 'X-XSRF-TOKEN'}"/>
  <meta name="koaderno-id" th:content="${koadernoAktiboa != null ? koadernoAktiboa.id : ''}">
   
  <!-- SortableJS (d&d) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --text:#111827; --line:#e5e7eb;
      --primary:#2563eb; --primary-600:#1d4ed8;
    }
    body{background:var(--bg); color:var(--text);}
    .stack{display:grid; gap:1rem;}
    .container{max-width:1000px; margin:1rem auto; padding:0 1rem;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.04);}
    .card-header{display:flex; align-items:center; gap:.75rem; padding:1rem 1rem; border-bottom:1px solid var(--line);}
    .card-body{padding:.75rem 1rem 1rem;}
    .muted{color:var(--muted); font-size:.95rem;}

    /* Ebaluaketa/UD/Jarduera akordeoia */
    .ebal-list, .ud-list, .jp-list{display:grid; gap:.5rem; list-style:none; padding:0; margin:0;}
    .ebal-item, .ud-item{background:#fff; border:1px solid var(--line); border-radius:12px; overflow:hidden;}
    .ebal-header, .ud-header{display:grid; grid-template-columns: 24px 1fr auto; align-items:center; gap:.5rem; padding:.8rem 1rem; cursor:pointer;}
    .caret{transition:transform .2s ease;}
    .ebal-item.open > .ebal-header .caret,
    .ud-item.open   > .ud-header   .caret{transform:rotate(90deg);}
    .handle{cursor:grab; opacity:.7;}
    .title{font-weight:700;}
    .badge{font-size:.85rem; color:var(--muted)}
    .hours-warn{color:#b91c1c; font-weight:600;} /* planifikatua > erabilgarri */

    .actions{display:flex; gap:.5rem;}
    .btn{display:inline-flex; align-items:center; gap:.4rem; padding:.45rem .7rem; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer;}
    .btn:hover{background:#f9fafb;}
    .btn-primary{background:var(--primary); color:#fff; border-color:var(--primary);}
    .btn-primary:hover{background:var(--primary-600);}
    .btn-primary:focus{outline:2px solid #93c5fd;outline-offset:2px;}
    .btn-ghost{background:transparent;}
    .btn-danger{ background:#dc2626; color:#fff; border-color:#dc2626; }
    .btn-danger:hover{ background:#b91c1c; }

    .add-row{display:flex; justify-content:center; padding:.8rem;}

    /* Jarduera zerrenda */
    .jp-list{gap:.4rem; margin:0; padding:.5rem 0 0 0;}
    .jp-item{background:#fff; border:1px dashed var(--line); border-radius:10px; padding:.55rem .7rem; display:grid; grid-template-columns:24px 1fr auto; align-items:center; gap:.5rem;}
    .jp-title{font-weight:500;}
    .jp-hours{color:var(--muted); margin-left:.5rem;}

    /* Modal (native <dialog>) */
    dialog.modal{border:none; border-radius:16px; width:min(560px, 92vw); padding:0; box-shadow:0 20px 60px rgba(0,0,0,.25);}
    .modal header{padding:1rem 1.2rem; border-bottom:1px solid var(--line); font-weight:700;}
    .modal .content{padding:1rem 1.2rem; display:grid; gap:.8rem;}
    .modal .actions{padding:1rem 1.2rem; display:flex; gap:.6rem; justify-content:flex-end; border-top:1px solid var(--line);}
    .field{display:grid; gap:.3rem;}
    .field label{font-size:.9rem; color:var(--muted);}
    .field input[type="text"], .field input[type="number"], .field input[type="date"]{padding:.55rem .7rem; border:1px solid var(--line); border-radius:10px; width:100%;}

  	/* Ebaluaketa koloreak (pastel bigunak) */
	  .ebal-item.color-1 { background-color: #e8f0fe; }  /* urdinxka */
	  .ebal-item.color-2 { background-color: #e7f9ed; }  /* berde argia */
	  .ebal-item.color-3 { background-color: #fff3cd; }  /* horixka */
	  .ebal-item.color-4 { background-color: #fce8e6; }  /* arrosa */
	  .ebal-item.color-5 { background-color: #f0e7ff; }  /* more argia */
	  .ebal-item.color-6 { background-color: #e0f7fa; }  /* turkesa leuna */
	
	  /* kolorea ez dadin disolbatu mugen eta zerrenden artean */
	  .ebal-item { border-left: 6px solid transparent; }
	  .ebal-item.color-1 { border-color: #a4c2fa; }
	  .ebal-item.color-2 { border-color: #9ee3b3; }
	  .ebal-item.color-3 { border-color: #ffe58a; }
	  .ebal-item.color-4 { border-color: #f9a8a8; }
	  .ebal-item.color-5 { border-color: #c3b4ff; }
	  .ebal-item.color-6 { border-color: #a7ecf0; }
  </style>
</head>
<body>
  <div th:if="${koadernoAktiboa != null}"
       th:replace="~{irakasleak/fragments/irakasle-navbar :: navbar(${koadernoAktiboa}, ${irakasleKoadernoAktiboak})}"></div>

  <main class="container stack">
    <div class="card">
      <div class="card-header">
        <div>
          <h1 style="margin:0; display:flex; align-items:baseline; gap:.5rem;">
            <span>Programazioa</span>
          </h1>
          <div class="muted"
               th:text="'Koadernoa: ' + ${koadernoAktiboa != null ? koadernoAktiboa.izena : '—'}">
          </div>
        </div>
        <div style="margin-left:auto; display:flex; gap:.5rem;">
          <button id="btn-open-add-ebal" class="btn btn-primary">+ Ebaluaketa berria</button>
          
          <!-- Programazioa inportatzeko botoia
		       soilik programazioa hutsik badago eta badago beste koadernorik -->
		      <button id="programazioaInportatuBtn"
		              class="btn"
		              th:if="${programazioaHutsik and !#lists.isEmpty(inportatzekoKoadernoak)}">
		        Programazioa inportatu
		      </button>

          <div th:if="${programazioaHutsik and #lists.isEmpty(inportatzekoKoadernoak)}"
               class="muted">
            Ez dago EEI kode berdina duen beste koadernorik programazioa inportatzeko.
          </div>
        </div>
      </div>

      <div class="card-body">
        <!-- EBALUAKETA -> UD -> JP -->
        <ul id="ebalList" class="ebal-list">
          <li th:each="eb, iter : ${ebaluaketak}"
		        th:with="colorIdx=${((iter.index) % 6) + 1}"
		        class="ebal-item"
		        th:attr="data-eb-id=${eb.id}"
		        th:classappend="| color-${colorIdx}|">
            <div class="ebal-header" onclick="toggleEbal(this)">
              <span class="caret">›</span>
              <div>
                <div class="title" th:text="${eb.izena}">1. Ebaluaketa</div>
                <div class="badge">
                  <!-- (planifikatuta / erabilgarri) -->
                  <span th:with="planif=${ebalUdOrduak[eb.id] ?: 0},
                                 dispo=${ebalDispon[eb.id] ?: 0}"
                        th:classappend="${planif > dispo} ? ' hours-warn' : ''"
                        th:text="|(${planif}h / ${dispo}h erabilgarri)|">
                    (0h / 0h erabilgarri)
                  </span>
                  <!-- Aukeran, data-mugak ere -->
                  <span class="badge"
                        th:text="| — ${eb.hasieraData} → ${eb.bukaeraData}|">
                    — 2025-09-10 → 2026-01-31
                  </span>
                </div>
              </div>
              <div class="actions" style="margin-left:auto" onclick="event.stopPropagation()">
                <button class="btn" th:attr="data-eb-id=${eb.id}" onclick="openEbalEdit(this)">Editatu</button>
              </div>
            </div>

            <div class="ebal-content" style="display:none; padding:.4rem 1rem 1rem;">
              <!-- EB barruko UD-ak -->
              <ul class="ud-list" th:attr="data-eb-id=${eb.id}">
                <li class="ud-item"
                    th:each="ud : ${eb.unitateak}"
                    th:attr="data-ud-id=${ud.id}">
                  <div class="ud-header" onclick="toggleUd(this)">
                    <span class="handle" title="Arrastatu ordena aldatzeko">≡</span>
                    <div>
                      <span class="title"
                            th:text="|${ud.kodea} — ${ud.izenburua}|">
                        UD1 — Izenburua
                      </span>
                      <span class="badge"
					        th:with="jp=${jpOrduakMap[ud.id] ?: 0}"
					        th:text="|(${ud.orduak}h) (jardueretan ${jp}h)|">
					       (0h) (jardueretan 0h)
					      </span>
                    </div>
                    <div class="actions" style="margin-left:auto" onclick="event.stopPropagation()">
                      <button class="btn" th:attr="data-ud-id=${ud.id}" onclick="openUdEdit(this)">Editatu</button>
                    </div>
                  </div>

                  <div class="ud-content" style="display:none; padding:.4rem 1rem 1rem;">
                    <ul class="jp-list" th:attr="data-ud-id=${ud.id}">
                      <li class="jp-item"
                          th:each="jp : ${ud.azpiJarduerak}"
                          th:attr="data-jp-id=${jp.id}">
                        <span class="handle" title="Arrastatu ordena aldatzeko">≡</span>
                        <div>
                          <span class="jp-title" th:text="${jp.izenburua}">Jarduera</span>
                          <span class="jp-hours" th:text="|(${jp.orduak}h)|">(0h)</span>
                        </div>
                        <div class="actions">
                          <button class="btn" th:attr="data-jp-id=${jp.id}" onclick="openJpEdit(this)">Editatu</button>
                        </div>
                      </li>
                    </ul>

                    <div class="add-row">
                      <button class="btn btn-primary" th:attr="data-ud-id=${ud.id}" onclick="openJpAdd(this)">
                        + Jarduera berria
                      </button>
                    </div>
                  </div>
                </li>
              </ul>

              <div class="add-row">
                <button class="btn btn-primary" th:attr="data-eb-id=${eb.id}" onclick="openUdAdd(this)">
                  + UD berria ebaluazio honetan
                </button>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </div>

    <!-- Denboralizaziora bolkatu --> 
    <div class="actions">
      <button id="btnPreviewBulk" class="btn btn-primary"
              th:attr="data-koaderno-id=${koadernoAktiboa.id}"
              th:disabled="${!canBulk}">
        Denboralizaziora bolkatu
      </button>
    </div>
    <div th:if="${!canBulk}" class="alert alert-warning mt-2">
      Ezin da bolkatu: egutegia/ordutegia/programazioa osatu gabe.
    </div>
  </main>

  <!-- MODAL: Ebaluaketa sortu/edita -->
  <dialog id="ebalModal" class="modal">
    <form method="dialog" id="ebalModalForm">
      <input type="hidden"
             th:if="${_csrf != null}"
             th:name="${_csrf.parameterName}"
             th:value="${_csrf.token}"/>
      <header>Ebaluaketa</header>
      <div class="content">
        <input type="hidden" id="ebalId">
        <div class="field">
          <label>Izena</label>
          <input type="text" id="ebalIzena" placeholder="1. Ebaluaketa" required>
        </div>
        <div class="field">
          <label>Hasiera data</label>
          <input type="date" id="ebalHasiera">
        </div>
        <div class="field">
          <label>Bukaera data</label>
          <input type="date" id="ebalBukaera">
        </div>
      </div>
      <div class="actions">
        <button id="ebalDeleteBtn"
                class="btn btn-danger"
                type="button"
                style="margin-right:auto; display:none;">
          Ezabatu ebaluaketa
        </button>
        <button class="btn" type="button" onclick="closeEbalModal()">Utzi</button>
        <button class="btn btn-primary" type="submit">Gorde</button>
      </div>
    </form>
  </dialog>

  <!-- MODAL: UD sortu/edita -->
  <dialog id="udModal" class="modal">
    <form method="dialog" id="udModalForm">
      <input type="hidden"
             th:if="${_csrf != null}"
             th:name="${_csrf.parameterName}"
             th:value="${_csrf.token}"/>
      <header>UDa</header>
      <div class="content">
        <input type="hidden" id="udId">
        <input type="hidden" id="udEbalId">
        <div class="field">
          <label>Kodea</label>
          <input type="text" id="udKodea" required>
        </div>
        <div class="field">
          <label>Izenburua</label>
          <input type="text" id="udIzenburua" required>
        </div>
        <div class="field">
          <label>Orduak (h)</label>
          <input type="number" id="udOrduak" min="0" step="1" value="0">
        </div>
      </div>
      <div class="actions">
        <button id="udDeleteBtn"
                class="btn btn-danger"
                type="button"
                style="margin-right:auto; display:none;">
          Ezabatu UD
        </button>
        <button class="btn" type="button" onclick="closeUdModal()">Utzi</button>
        <button class="btn btn-primary" type="submit">Gorde</button>
      </div>
    </form>
  </dialog>

  <!-- MODAL: Jarduera sortu/edita -->
  <dialog id="jpModal" class="modal">
    <form method="dialog" id="jpModalForm">
      <input type="hidden"
             th:if="${_csrf != null}"
             th:name="${_csrf.parameterName}"
             th:value="${_csrf.token}"/>
      <header>Jarduera</header>
      <div class="content">
        <input type="hidden" id="jpId">
        <input type="hidden" id="jpUdId">
        <div class="field">
          <label>Izenburua</label>
          <input type="text" id="jpIzenburua" required>
        </div>
        <div class="field">
          <label>Orduak (h)</label>
          <input type="number" id="jpOrduak" min="0" step="1" value="0">
        </div>
      </div>
      <div class="actions">
        <button id="jpDeleteBtn"
                class="btn btn-danger"
                type="button"
                style="margin-right:auto; display:none;">
          Ezabatu jarduera
        </button>
        <button class="btn" type="button" onclick="closeJpModal()">Utzi</button>
        <button class="btn btn-primary" type="submit">Gorde</button>
      </div>
    </form>
  </dialog>
  
  <!-- Programazioa inportatzeko modala (fragment-a) -->
  <div th:replace="~{irakasleak/programazioa/programazioa-inport-modala :: programazioa-inport-modal}"></div>

  <!-- SCRIPT NAGUSIAK -->
  <script>
  // ---------- CSRF helpers ----------
  function getCookie(name){
    const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]*)'));
    return m ? decodeURIComponent(m[2]) : '';
  }
  const metaToken  = document.querySelector('meta[name="_csrf"]')?.content || '';
  const metaHeader = document.querySelector('meta[name="_csrf_header"]')?.content || '';
  const cookieToken = getCookie('XSRF-TOKEN');
  const KOADERNO_ID = document.querySelector('meta[name="koaderno-id"]')?.content || '';

  const CSRF_TOKEN  = metaToken || cookieToken || '';
  const CSRF_HEADER = metaToken ? (metaHeader || 'X-CSRF-TOKEN')
                                : (cookieToken ? 'X-XSRF-TOKEN' : '');

  // ---------- Open state (ebal/UD irekiak gordetzeko) ----------
  const OPEN_STATE_KEY = 'programazioaOpenState_' + (KOADERNO_ID || 'default');

  function saveOpenState() {
    const openEb = Array.from(document.querySelectorAll('.ebal-item.open'))
      .map(li => li.getAttribute('data-eb-id'));

    const openUd = Array.from(document.querySelectorAll('.ud-item.open'))
      .map(li => li.getAttribute('data-ud-id'));

    const state = { eb: openEb, ud: openUd };
    try {
      localStorage.setItem(OPEN_STATE_KEY, JSON.stringify(state));
    } catch (e) {
      console.warn('Ezin izan da openState gorde', e);
    }
  }

  function restoreOpenState() {
    let raw = null;
    try {
      raw = localStorage.getItem(OPEN_STATE_KEY);
    } catch (e) {
      console.warn('Ezin izan da openState irakurri', e);
      return;
    }
    if (!raw) return;

    let state;
    try {
      state = JSON.parse(raw);
    } catch (e) {
      console.warn('openState JSON hondatuta dago', e);
      return;
    }

    if (state.eb && Array.isArray(state.eb)) {
      state.eb.forEach(id => {
        const li = document.querySelector(`.ebal-item[data-eb-id="${id}"]`);
        if (!li) return;
        li.classList.add('open');
        const content = li.querySelector('.ebal-content');
        if (content) content.style.display = 'block';
      });
    }

    if (state.ud && Array.isArray(state.ud)) {
      state.ud.forEach(id => {
        const li = document.querySelector(`.ud-item[data-ud-id="${id}"]`);
        if (!li) return;
        li.classList.add('open');
        const content = li.querySelector('.ud-content');
        if (content) content.style.display = 'block';
      });
    }
  }

  function reloadKeepingState() {
    saveOpenState();
    window.location.reload();
  }

  document.addEventListener('DOMContentLoaded', restoreOpenState);

  const fjson = (url, method, body) => fetch(url, {
    method,
    credentials: 'same-origin',
    headers: Object.assign(
      { 'Content-Type': 'application/json' },
      CSRF_TOKEN ? { [CSRF_HEADER]: CSRF_TOKEN } : {}
    ),
    body: body ? JSON.stringify(body) : undefined
  })
  .then(async r => {
    const ct = r.headers.get('content-type') || '';
    const isJson = ct.includes('application/json');

    let data = null;
    if (isJson) {
      try {
        data = await r.json();
      } catch (e) {
        console.warn('JSON parse errorea', e);
      }
    }

    if (!r.ok) {
      const msg =
        (data && (data.error || data.message)) ||
        ('HTTP ' + r.status);
      throw new Error(msg);
    }

    // OK bada, JSON bueltatzen badu datu hori; bestela {ok:true}
    return data ?? { ok: true };
  })
  .catch(e => {
    console.error(e);
    alert('Errorea: ' + e.message);
    throw e;
  });

  // ---------- accordion ----------
  function toggleEbal(el){
    const item = el.closest('.ebal-item');
    item.classList.toggle('open');
    const content = item.querySelector('.ebal-content');
    content.style.display = content.style.display === 'none' ? 'block' : 'none';

    saveOpenState();
  }
  function toggleUd(el){
    const item = el.closest('.ud-item');
    item.classList.toggle('open');
    const content = item.querySelector('.ud-content');
    content.style.display = content.style.display === 'none' ? 'block' : 'none';

    saveOpenState();
  }

  // ---------- Ebaluaketa modal ----------
  const ebalModal = document.getElementById('ebalModal');
  const ebalForm  = document.getElementById('ebalModalForm');
  const ebalDeleteBtn = document.getElementById('ebalDeleteBtn');

  document.getElementById('btn-open-add-ebal').addEventListener('click', () => {
    ebalForm.reset();
    document.getElementById('ebalId').value = '';
    ebalDeleteBtn.style.display = 'none';
    ebalModal.showModal();
  });

  function openEbalEdit(btn){
    const id = btn.getAttribute('data-eb-id');
    fjson(`/irakasle/programazioa/api/ebal/${id}`, 'GET').then(d=>{
      document.getElementById('ebalId').value = d.id;
      document.getElementById('ebalIzena').value = d.izena || '';
      document.getElementById('ebalHasiera').value = d.hasieraData || '';
      document.getElementById('ebalBukaera').value = d.bukaeraData || '';

      ebalDeleteBtn.style.display = 'inline-flex';
      ebalDeleteBtn.onclick = () => {
        if (confirm('Ziur zaude ebaluaketa hau (eta bere UD guztiak) ezabatu nahi dituzula?')) {
          fjson(`/irakasle/programazioa/api/ebal/${d.id}`, 'DELETE').then(()=>reloadKeepingState());
        }
      };
      ebalModal.showModal();
    });
  }
  function closeEbalModal(){ ebalModal.close(); }

  ebalForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const payload = {
      id: document.getElementById('ebalId').value || null,
      izena: document.getElementById('ebalIzena').value,
      hasieraData: document.getElementById('ebalHasiera').value || null,
      bukaeraData: document.getElementById('ebalBukaera').value || null
    };
    const url = payload.id ? `/irakasle/programazioa/api/ebal/${payload.id}` : `/irakasle/programazioa/api/ebal`;
    const method = payload.id ? 'PUT' : 'POST';
    fjson(url, method, payload).then(()=>reloadKeepingState());
  });

  // ---------- UD modal ----------
  const udModal = document.getElementById('udModal');
  const udForm  = document.getElementById('udModalForm');
  const udDeleteBtn = document.getElementById('udDeleteBtn');

  function openUdAdd(btn){
    udForm.reset();
    document.getElementById('udId').value = '';
    document.getElementById('udEbalId').value = btn.getAttribute('data-eb-id');
    udDeleteBtn.style.display = 'none';
    udModal.showModal();
  }
  function openUdEdit(btn){
    const id = btn.getAttribute('data-ud-id');
    fjson(`/irakasle/programazioa/api/ud/${id}`, 'GET').then(d=>{
      document.getElementById('udId').value = d.id;
      document.getElementById('udEbalId').value = d.ebaluaketaId;
      document.getElementById('udKodea').value = d.kodea;
      document.getElementById('udIzenburua').value = d.izenburua;
      document.getElementById('udOrduak').value = d.orduak ?? 0;

      udDeleteBtn.style.display = 'inline-flex';
      udDeleteBtn.onclick = () => {
        if (confirm('Ziur zaude UD hau (eta bere jarduera guztiak) ezabatu nahi dituzula?')) {
          fjson(`/irakasle/programazioa/api/ud/${d.id}`, 'DELETE').then(()=>reloadKeepingState());
        }
      };
      udModal.showModal();
    });
  }
  function closeUdModal(){ udModal.close(); }

  udForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const payload = {
      id: document.getElementById('udId').value || null,
      ebaluaketaId: parseInt(document.getElementById('udEbalId').value, 10),
      kodea: document.getElementById('udKodea').value,
      izenburua: document.getElementById('udIzenburua').value,
      orduak: parseInt(document.getElementById('udOrduak').value || '0', 10)
    };
    const url = payload.id ? `/irakasle/programazioa/api/ud/${payload.id}` : `/irakasle/programazioa/api/ud`;
    const method = payload.id ? 'PUT' : 'POST';
    fjson(url, method, payload).then(()=>reloadKeepingState());
  });

  // ---------- JP modal ----------
  const jpModal = document.getElementById('jpModal');
  const jpForm  = document.getElementById('jpModalForm');
  const jpDeleteBtn = document.getElementById('jpDeleteBtn');

  function openJpAdd(btn){
    jpForm.reset();
    document.getElementById('jpId').value = '';
    document.getElementById('jpUdId').value = btn.getAttribute('data-ud-id');
    jpDeleteBtn.style.display = 'none';
    jpModal.showModal();
  }
  function openJpEdit(btn){
    const id = btn.getAttribute('data-jp-id');
    fjson(`/irakasle/programazioa/api/jp/${id}`, 'GET').then(d=>{
      document.getElementById('jpId').value = d.id;
      document.getElementById('jpUdId').value = d.udId;
      document.getElementById('jpIzenburua').value = d.izenburua;
      document.getElementById('jpOrduak').value = d.orduak ?? 0;

      jpDeleteBtn.style.display = 'inline-flex';
      jpDeleteBtn.onclick = () => {
        if (confirm('Ziur zaude jarduera hau ezabatu nahi duzula?')) {
          fjson(`/irakasle/programazioa/api/jp/${d.id}`, 'DELETE').then(()=>reloadKeepingState());
        }
      };
      jpModal.showModal();
    });
  }
  function closeJpModal(){ jpModal.close(); }

  jpForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const id = document.getElementById('jpId').value;
    const payload = {
      udId: parseInt(document.getElementById('jpUdId').value, 10),
      izenburua: document.getElementById('jpIzenburua').value,
      orduak: parseInt(document.getElementById('jpOrduak').value || '0', 10)
    };
    const url = id ? `/irakasle/programazioa/api/jp/${id}` : `/irakasle/programazioa/api/jp`;
    const method = id ? 'PUT' : 'POST';
    fjson(url, method, id ? payload : { ...payload }).then(()=>reloadKeepingState());
  });

  // ---------- d&d: UD ordena (ebaluazio barruan) + kross-ebaluaketa ----------
  document.querySelectorAll('.ud-list').forEach(list=>{
    new Sortable(list, {
      group: { name:'ud', pull:true, put:true },
      handle: '.handle',
      animation: 150,
      onEnd: (evt)=>{
        const udId = parseInt(evt.item.getAttribute('data-ud-id'));
        const toEbalId = parseInt(evt.to.getAttribute('data-eb-id'));
        const newIndex = evt.newIndex;
        fjson('/irakasle/programazioa/api/ud/mugitu', 'POST', { udId, toEbaluaketaId: toEbalId, newIndex });
      }
    });
  });

  // ---------- d&d: JP (kross-UD mugimendua ere bai) ----------
  document.querySelectorAll('.jp-list').forEach(list=>{
    new Sortable(list, {
      group: 'jp',
      handle: '.handle',
      animation: 150,
      onEnd: (evt)=>{
        const jpId = parseInt(evt.item.getAttribute('data-jp-id'));
        const toUdId = parseInt(evt.to.getAttribute('data-ud-id'));
        const newIndex = evt.newIndex;
        fjson('/irakasle/programazioa/api/jp/mugitu', 'POST', { jpId, toUdId, newIndex });
      }
    });
  });

  // ------- Programazioa --> Denboralizazioa (aurreikuspenik gabe, zuzenean POST) -------
  (function(){
    const btn = document.getElementById('btnPreviewBulk');
    if(!btn) return;

    const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    btn.addEventListener('click', async ()=>{
      const koadernoId = btn.dataset.koadernoId;
      if(!koadernoId){
        alert('Ezin da bolkatu: koadernoa ez dago zehaztuta.');
        return;
      }

      const onartu = confirm(
        'Ziur zaude programazioa denboralizaziora bolkatu nahi duzula?\n' +
        'Aurreko planifikazioak gainidatzi daitezke.'
      );
      if(!onartu) return;

      const params = new URLSearchParams();
      params.set('koadernoId', koadernoId);
      params.set('replaceExisting', 'true'); // lehen checkbox-a checked zegoen bezala

      try{
        const res = await fetch('/irakasle/programazioa/bolkatu', {
          method: 'POST',
          headers: {
            'Content-Type':'application/x-www-form-urlencoded',
            ...(csrfHeader && csrfToken ? { [csrfHeader]: csrfToken } : {})
          },
          body: params.toString()
        });

        if(res.redirected){
          // adib. /irakasle/denboralizazioa-ra edo /irakasle/programazioa-ra
          window.location = res.url;
          return;
        }
        if(!res.ok){
          const txt = await res.text();
          alert(txt || 'Errorea bolkatzean.');
          return;
        }

        // Bestela, arrakastatsua bada baina ez badago redirect-ik, berriz kargatu:
        reloadKeepingState();
      }catch(e){
        console.error(e);
        alert('Errore ezustekoa bolkatzean.');
      }
    });
  })();
  </script>

  <!-- Programazioa inportatu MODALAREN script-a -->
  <script>
  // ---------- Programazioa inportatu modala ----------
  (function() {
    const modal = document.getElementById('programazioaImportModal');
    const openBtn = document.getElementById('programazioaInportatuBtn');
    const closeBtn = modal ? modal.querySelector('#modalCloseBtn') : null;
    const aurreikuspenEdukia = modal ? modal.querySelector('#aurreikuspenEdukia') : null;
    const inportatuForm = document.getElementById('inportatuForm');
    const iturburuaInput = document.getElementById('iturburuaId');

    // Botoia edo modala ez badago (adib. programazioa ez badago hutsik),
    // ez da ezer egiten eta ez du errorea sortzen.
    if (!modal || !openBtn) return;

    function openModal() {
      modal.classList.add('show');
    }
    function closeModal() {
      modal.classList.remove('show');
    }

    openBtn.addEventListener('click', openModal);

    if (closeBtn) {
      closeBtn.addEventListener('click', closeModal);
    }

    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Modal barruko click-ak: aurreikusi + inportatu
    modal.addEventListener('click', function(e) {
      const aurreikusiBtn = e.target.closest('.aurreikusi-btn');
      const inportatuBtn = e.target.closest('.inportatu-btn');

      if (aurreikusiBtn && aurreikuspenEdukia) {
        const id = aurreikusiBtn.getAttribute('data-id');
        if (!id) return;
        aurreikuspenEdukia.innerHTML =
          '<p style="color:#6b7280;font-size:0.9rem;">Kargatzen...</p>';

        fetch('/irakasle/programazioa/aurreikusi/' + id)
          .then(r => r.text())
          .then(html => {
            aurreikuspenEdukia.innerHTML = html;
          })
          .catch(() => {
            aurreikuspenEdukia.innerHTML =
              '<p style="color:#b91c1c;font-size:0.9rem;">Errorea aurreikuspena kargatzean.</p>';
          });
      }

      if (inportatuBtn && inportatuForm && iturburuaInput) {
        const id = inportatuBtn.getAttribute('data-id');
        if (!id) return;
        if (!confirm('Ziur zaude programazio hau uneko koadernora inportatu nahi duzula? ' +
                     'Oraingo programazioa gainidatzi daiteke.')) {
          return;
        }
        iturburuaInput.value = id;
        inportatuForm.submit();
      }
    });
  })();
  </script>

</body>
</html>
