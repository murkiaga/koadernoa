<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="eu">
<head>
  <meta charset="UTF-8">
  <title>Estatistikak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" th:href="@{/css/irakasle-navbar.css}">
  <link rel="stylesheet" th:href="@{/css/irakasle-common.css}">
  <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
  <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : 'X-XSRF-TOKEN'}"/>

  <style>
    body{
      background:#f3f4f6; /* commons-eko #f9fafb-etik apur bat ilunagoa, nahi baduzu kendu */
    }
    .page{
      max-width:1000px;
      width:80%;
      margin:1.5rem auto;
      padding:0 1rem 2rem;
    }

    .card{
      padding:1rem 1.2rem;
    }
    h1{font-size:1.2rem;margin:0 0 .25rem 0;}
    .muted{color:#6b7280;font-size:.9rem;}

    .table-wrap{overflow-x:auto;margin-top:1rem;}

    table{
      min-width:720px;
    }
    th,td{
      text-align:center;
    }
    th span.sub{
      display:block;
      font-size:.75rem;
      color:#6b7280;
      margin-top:.15rem;
    }
    td.label{
      font-weight:600;
      text-align:left;
      white-space:nowrap;
    }

    input[type="number"]{
      width:70px;
      padding:.25rem .35rem;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:.85rem;
      text-align:right;
    }

    .actions-bar{
      display:flex;
      justify-content:flex-end;
      margin-top:.75rem;
    }

    .thresh{
      font-size:.75rem;
      color:#6b7280;
      margin-left:.25rem;
      white-space:nowrap;
    }
  </style>
</head>
<body>

<div th:if="${koadernoAktiboa != null}"
     th:replace="~{irakasleak/fragments/irakasle-navbar :: navbar(${koadernoAktiboa}, ${irakasleKoadernoAktiboak})}">
</div>

<div class="page">

  <div th:if="${!koadernoAktiboDago}">
    <p>Ez dago koaderno aktiborik. Aukeratu koaderno bat hasiera orritik.</p>
  </div>

  <div th:if="${koadernoAktiboDago}" class="card">
    <div>
      <h1>Estatistikak</h1>
      <div class="muted"
           th:text="'Koadernoa: ' + ${koadernoAktiboa != null ? koadernoAktiboa.izena : '—'}">
        Koadernoa
      </div>
    </div>

    <div class="table-wrap"
         th:if="${estatistikak != null and !estatistikak.isEmpty()}">
      <form th:action="@{/irakasle/estatistikak/eguneratu}" method="post">
        <input type="hidden"
               th:if="${_csrf != null}"
               th:name="${_csrf.parameterName}"
               th:value="${_csrf.token}"/>

        <table>
		  <thead>
		  <tr>
		    <th>Ebaluazioa</th>
		    <th>
		      UD-ak
		      <span class="sub">emanda / aurreikusita</span>
		    </th>
		    <th>
		      Orduak
		      <span class="sub">emanda / aurreikusita</span>
		    </th>
		    <th>
		      Aprobatuak
		      <span class="sub">gainditu / ebaluatu</span>
		    </th>
		    <th>
		      Hutsegite orduak
		      <span class="sub">(HUTS + JUSTIFIKATUA)</span>
		    </th>
		    <th>Ekintzak</th>
		  </tr>
		  </thead>
		
		  <tbody>
		  <tr th:each="e : ${estatistikak}">
		    <!-- Ebaluazio momentuaren izena -->
		    <td class="label">
		      <span th:text="${e.ebaluazioMomentua != null ? e.ebaluazioMomentua.izena : '—'}">
		        1. Ebaluazioa
		      </span>
		    </td>
		
		    <!-- UD: emanda (input) / aurreikusita (readonly) + %ak -->
		    <td>
		      <div>
		        <input type="number" min="0"
		               th:name="|unitateakEmanda_${e.id}|"
		               th:value="${e.unitateakEmanda}">
		        /
		        <span th:text="${e.unitateakAurreikusiak}">0</span>
		      </div>
		      <div class="muted" style="font-size:.75rem;margin-top:0.1rem;">
		        <!-- Benetako % -->
		        <span th:if="${e.udPortzentaia != null}"
		              th:text="|${e.udPortzentaia}%|">
		          100%
		        </span>
		        <!-- Konfiguratutako muga -->
		        <span th:if="${e.ebaluazioMomentua != null and e.ebaluazioMomentua.ezadostasunKonfig != null}"
		              th:text="| (>= ${e.ebaluazioMomentua.ezadostasunKonfig.minBlokePortzentaia}% )|">
		          (>= 80%)
		        </span>
		      </div>
		    </td>
		
		    <!-- Orduak: emanda / aurreikusita + %ak -->
		    <td>
		      <div>
		        <input type="number" min="0"
		               th:name="|orduakEmanda_${e.id}|"
		               th:value="${e.orduakEmanda}">
		        /
		        <span th:text="${e.orduakAurreikusiak}">0</span>
		      </div>
		      <div class="muted" style="font-size:.75rem;margin-top:0.1rem;">
		        <span th:if="${e.orduPortzentaia != null}"
		              th:text="|${e.orduPortzentaia}%|">
		          83%
		        </span>
		        <span th:if="${e.ebaluazioMomentua != null and e.ebaluazioMomentua.ezadostasunKonfig != null}"
		              th:text="| (>= ${e.ebaluazioMomentua.ezadostasunKonfig.minOrduPortzentaia}% )|">
		          (>= 70%)
		        </span>
		      </div>
		    </td>
		
		    <!-- Aprobatuak: gainditu / ebaluatu + %ak -->
		    <td>
		      <div th:text="|${e.aprobatuak} / ${e.ebaluatuak}|">
		        0 / 0
		      </div>
		      <div class="muted" style="font-size:.75rem;margin-top:0.1rem;">
		        <span th:if="${e.gaindituPortzentaia != null}"
		              th:text="|${e.gaindituPortzentaia}%|">
		          83%
		        </span>
		        <span th:if="${e.ebaluazioMomentua != null and e.ebaluazioMomentua.ezadostasunKonfig != null}"
		              th:text="| (>= ${e.ebaluazioMomentua.ezadostasunKonfig.minGaindituPortzentaia}% )|">
		          (>= 60%)
		        </span>
		      </div>
		    </td>
		
		    <!-- Hutsegite orduak + bertaratze % -->
		    <td>
		      <div th:text="${e.hutsegiteOrduak}">
		        0
		      </div>
		      <div class="muted" style="font-size:.75rem;margin-top:0.1rem;">
				  <!-- Bertaratze portzentaia (adib. 96.2% bertaratzea) -->
				  <span th:if="${e.bertaratzePortzentaia != null}">
				    <span th:text="${#numbers.formatDecimal(e.bertaratzePortzentaia, 2, 2)}">96.21</span>%
				  </span>
				
				  <!-- Muga konfiguratuarekin (adib. (≥ 80%)) -->
				  <span th:if="${e.ebaluazioMomentua != null and e.ebaluazioMomentua.ezadostasunKonfig != null}">
				    (
				    ≥
				    <span th:text="${e.ebaluazioMomentua.ezadostasunKonfig.minBertaratzePortzentaia}">80</span>%
				    )
				  </span>
			  </div>
		    </td>
		
		    <!-- Ekintzak: Berkalkulatu botoia -->
		    <td>
		      <button type="button"
		              class="btn btn-sm"
		              th:attr="data-est-id=${e.id}"
		              onclick="berkalkulatuEstatistika(this)">
		        Berkalkulatu
		      </button>
		    </td>
		  </tr>
		  </tbody>
		</table>


        <div class="actions-bar">
          <button type="submit" class="btn btn-primary">
            Aldaketak gorde
          </button>
        </div>
      </form>
    </div>

    <div th:if="${estatistikak == null or #lists.isEmpty(estatistikak)}"
         style="margin-top:1rem;">
      Oraindik ez dago estatistika-erregistrorik koaderno honetarako.
      (Normalean, koaderno berria sortzean automatikoki sortzen dira.)
    </div>
  </div>

</div>

<script>
  (function(){
    const metaToken  = document.querySelector('meta[name="_csrf"]')?.content || '';
    const metaHeader = document.querySelector('meta[name="_csrf_header"]')?.content || '';

    window.berkalkulatuEstatistika = async function(btn){
      const id = btn.getAttribute('data-est-id');
      if (!id) return;

      if (!confirm('Ziur zaude ebaluazio momentu honetako estatistikak berriz kalkulatu nahi dituzula?\n' +
                   'Eskuz jarritako "emandako" balioak gainidatz daitezke.')) {
        return;
      }

      try {
        const res = await fetch(`/irakasle/estatistikak/${id}/berkalkulatu`, {
          method: 'POST',
          headers: Object.assign(
            { 'Content-Type': 'application/json' },
            metaToken ? { [metaHeader || 'X-CSRF-TOKEN']: metaToken } : {}
          ),
          body: '{}'
        });

        if (!res.ok) {
          const txt = await res.text();
          alert(txt || 'Errorea berkalkulatzean.');
          return;
        }
        window.location.reload();
      } catch (e) {
        console.error(e);
        alert('Errore ezustekoa berkalkulatzean.');
      }
    };
  })();
</script>

</body>
</html>
