<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="eu">
<head>
  <meta charset="UTF-8">
  <title>Estatistikak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" th:href="@{/css/irakasle-navbar.css}">
  <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
  <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : 'X-XSRF-TOKEN'}"/>

  <style>
    body{background:#f3f4f6;color:#111827;font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;}
    .page{max-width:1000px;margin:1.5rem auto;padding:0 1rem;}
    .card{background:#fff;border-radius:12px;border:1px solid #e5e7eb;box-shadow:0 2px 8px rgba(0,0,0,.04);padding:1rem 1.2rem;}
    h1{font-size:1.2rem;margin:0 0 .25rem 0;}
    .muted{color:#6b7280;font-size:.9rem;}

    .table-wrap{overflow-x:auto;margin-top:1rem;}
    table{width:100%;border-collapse:collapse;min-width:720px;}
    th,td{border:1px solid #e5e7eb;padding:.45rem .55rem;font-size:.9rem;text-align:center;}
    th{background:#f9fafb;font-weight:600;}
    th span.sub{display:block;font-size:.75rem;color:#6b7280;margin-top:.15rem;}
    td.label{font-weight:600;text-align:left;}

    input[type="number"]{
      width:70px;
      padding:.25rem .35rem;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:.85rem;
      text-align:right;
    }
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      border-radius:999px;
      padding:.35rem .75rem;
      border:1px solid #d1d5db;
      background:#fff;
      font-size:.8rem;
      cursor:pointer;
    }
    .btn-primary{
      background:#2563eb;color:#fff;border-color:#2563eb;
    }
    .btn-primary:hover{background:#1d4ed8;}
    .btn-sm{font-size:.75rem;padding:.25rem .6rem;}

    .actions-bar{display:flex;justify-content:flex-end;margin-top:.75rem;}
    .tag{
      display:inline-block;padding:.1rem .4rem;border-radius:999px;
      background:#e5e7eb;font-size:.7rem;color:#374151;
    }
  </style>
</head>
<body>

<div th:if="${koadernoAktiboa != null}"
     th:replace="~{irakasleak/fragments/irakasle-navbar :: navbar(${koadernoAktiboa}, ${irakasleKoadernoAktiboak})}">
</div>

<div class="page">

  <div th:if="${!koadernoAktiboDago}">
    <p>Ez dago koaderno aktiborik. Aukeratu koaderno bat hasiera orritik.</p>
  </div>

  <div th:if="${koadernoAktiboDago}" class="card">
    <div>
      <h1>Estatistikak</h1>
      <div class="muted"
           th:text="'Koadernoa: ' + ${koadernoAktiboa != null ? koadernoAktiboa.izena : '—'}">
        Koadernoa
      </div>
    </div>

    <div class="table-wrap" th:if="${estatistikak != null and !estatistikak.isEmpty()}">
      <form th:action="@{/irakasle/estatistikak/eguneratu}" method="post">
        <input type="hidden"
               th:if="${_csrf != null}"
               th:name="${_csrf.parameterName}"
               th:value="${_csrf.token}"/>

        <table>
          <thead>
          <tr>
            <th>Ebaluazioa</th>
            <th>
              UD-ak
              <span class="sub">emanda / aurreikusita</span>
            </th>
            <th>
              Orduak
              <span class="sub">emanda / aurreikusita</span>
            </th>
            <th>
              Aprobatuak
              <span class="sub">gainditu / ebaluatu</span>
            </th>
            <th>
              Hutsegite orduak
              <span class="sub">(HUTS + JUSTIFIKATUA)</span>
            </th>
            <th>Ekintzak</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="e : ${estatistikak}">
            <!-- Ebaluazio momentuaren izena -->
            <td class="label">
              <span th:text="${e.ebaluazioMomentua != null ? e.ebaluazioMomentua.izena : '—'}">
                1. Ebaluazioa
              </span>
            </td>

            <!-- UD: emanda (input) / aurreikusita (readonly) -->
            <td>
              <input type="number" min="0"
                     th:name="|unitateakEmanda_${e.id}|"
                     th:value="${e.unitateakEmanda}">
              /
              <span th:text="${e.unitateakAurreikusiak}">0</span>
            </td>

            <!-- Orduak: emanda (input) / aurreikusita (readonly) -->
            <td>
              <input type="number" min="0"
                     th:name="|orduakEmanda_${e.id}|"
                     th:value="${e.orduakEmanda}">
              /
              <span th:text="${e.orduakAurreikusiak}">0</span>
            </td>

            <!-- Aprobatuak: gainditu / ebaluatu -->
            <td th:text="|${e.aprobatuak} / ${e.ebaluatuak}|">
              0 / 0
            </td>

            <!-- Hutsegite orduak -->
            <td th:text="${e.hutsegiteOrduak}">
              0
            </td>

            <!-- Ekintzak: Berkalkulatu botoia -->
            <td>
              <button type="button"
                      class="btn btn-sm"
                      th:attr="data-est-id=${e.id}"
                      onclick="berkalkulatuEstatistika(this)">
                Berkalkulatu
              </button>
            </td>
          </tr>
          </tbody>
        </table>

        <div class="actions-bar">
          <button type="submit" class="btn btn-primary">
            Aldaketak gorde
          </button>
        </div>
      </form>
    </div>

    <div th:if="${estatistikak == null or #lists.isEmpty(estatistikak)}" style="margin-top:1rem;">
      Oraindik ez dago estatistika-erregistrorik koaderno honetarako.
      (Normalean, koaderno berria sortzean automatikoki sortzen dira.)
    </div>
  </div>

</div>

<script>
  (function(){
    const metaToken  = document.querySelector('meta[name="_csrf"]')?.content || '';
    const metaHeader = document.querySelector('meta[name="_csrf_header"]')?.content || '';

    window.berkalkulatuEstatistika = async function(btn){
      const id = btn.getAttribute('data-est-id');
      if (!id) return;

      if (!confirm('Ziur zaude ebaluazio momentu honetako estatistikak berriz kalkulatu nahi dituzula?\\n' +
                   'Eskuz jarritako \"emandako\" balioak gainidatz daitezke.')) {
        return;
      }

      try {
        const res = await fetch(`/irakasle/estatistikak/${id}/berkalkulatu`, {
          method: 'POST',
          headers: Object.assign(
            { 'Content-Type': 'application/json' },
            metaToken ? { [metaHeader || 'X-CSRF-TOKEN']: metaToken } : {}
          ),
          body: '{}'
        });

        if (!res.ok) {
          const txt = await res.text();
          alert(txt || 'Errorea berkalkulatzean.');
          return;
        }
        // ondo: berriz kargatu pantaila
        window.location.reload();
      } catch (e) {
        console.error(e);
        alert('Errore ezustekoa berkalkulatzean.');
      }
    };
  })();
</script>

</body>
</html>
