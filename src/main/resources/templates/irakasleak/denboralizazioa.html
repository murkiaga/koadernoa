<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="eu">
<head>
    <meta charset="UTF-8">
    <title>Denboralizazioa</title>
    <link rel="stylesheet" th:href="@{/css/irakasle-navbar.css}">
    <link rel="stylesheet" th:href="@{/css/jarduera-modal.css}">
    <style>

        h2, h3 {
            text-transform: capitalize;
        }

        .hilabetea {
            margin-bottom: 2rem;
        }

        .taula-egutegia {
            width: 100%;
            border-collapse: collapse;
        }

        .taula-egutegia th,
        .taula-egutegia td {
            border: 1px solid #ccc;
            vertical-align: top;
            width: 20%; /* 5 zutabe: AL-OR */
            height: 90px;
            position: relative;
        }

        .taula-egutegia th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
            padding: 3px;      /* Lehen 8px edo gehiagokoa izan daiteke */
		    height: 24px;      /* Altueraren kontrol zuzena */
		    font-size: 0.9rem; /* Letra tamaina txikiagoa nahi baduzu */
        }

        .egun-zenbakia {
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 0.75rem;
            color: #333;
        }

        .blank {
            background-color: #f0f0f0;
        }

        .lektibo1 { background-color: #b3d9ff; }
        .lektibo2 { background-color: #ffd699; }
        .lektibo3 { background-color: #b2f2bb; }
        .jaieguna { background-color: #ffe6e6; color: red; font-weight: bold; }
        .ezlektiboa { background-color: black; color: white; }
        .ordezkatua { background-color: yellow; }
        .egun-zenbakia.testu-zuria {
		    color: white !important;
		}
		
		.jarduerak{list-style:none;margin:22px 4px 4px;padding:0;display:flex;flex-direction:column;gap:4px}
		.jarduera-item{font-size:.8rem;line-height:1.2;border-radius:6px;padding:2px 6px;border:1px solid #e5e7eb;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
		.jarduera-item:hover{background:#f3f4f6}

		.btn.danger {
		    background: #dc2626; /* gorria */
		    color: white;
		    border: none;
		    padding: 6px 10px;
		    border-radius: 6px;
		    cursor: pointer;
		  }
		 .btn.danger:hover { filter: brightness(0.95); }
		 
		 .modal-actions {
		  display: flex;
		  align-items: center;
		  justify-content: flex-end; /* eskubi aldeko botoiak */
		  gap: 0.5rem;
		}
		
		.modal-actions .btn.danger {
		  margin-right: auto; /* bultzatu ezkerrera */
		  background: #dc2626;
		  color: white;
		  border: none;
		  padding: 6px 10px;
		  border-radius: 6px;
		  cursor: pointer;
		}
		.modal-actions .btn.danger:hover { filter: brightness(0.95); }

		.btn-asistentzia{
		  position:absolute; left:6px; top:4px; 
		  font-size:.85rem; text-decoration:none;
		  padding:2px 6px; border:1px solid #ddd; border-radius:6px;
		  background:#fff; cursor:pointer
		}
		.btn-asistentzia:hover{ background:#f3f4f6 }

    </style>
    
   	<script th:src="@{/js/jarduera-modal.js}"></script>
   
</head>
<body>

<!-- Navbar -->
<div th:if="${koadernoAktiboa != null}"
     th:replace="irakasleak/fragments/irakasle-navbar :: navbar(${koadernoAktiboa}, ${irakasleKoadernoAktiboak})"></div>

<!-- Hilabetea + botoiak -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <a th:href="@{/irakasle/denboralizazioa(hilabetea=${hilabetea == 1 ? 12 : hilabetea - 1}, urtea=${hilabetea == 1 ? urtea - 1 : urtea})}">
        â¬… Aurrekoa
    </a>

    <h2 th:text="${hilabeteUrtea}" style="margin: 0; text-align: center; flex: 1;">Hilabetea</h2>

    <a th:href="@{/irakasle/denboralizazioa(hilabetea=${hilabetea == 12 ? 1 : hilabetea + 1}, urtea=${hilabetea == 12 ? urtea + 1 : urtea})}">
        Hurrengoa âž¡
    </a>
</div>

<!-- Egutegi taula -->
<table class="taula-egutegia">
    <thead>
        <tr>
            <th>Astelehena</th>
            <th>Asteartea</th>
            <th>Asteazkena</th>
            <th>Osteguna</th>
            <th>Ostirala</th>
        </tr>
    </thead>
    <tbody>
        <tr th:each="astea : ${asteak}">
		    <td th:each="egunaBista : ${astea}"
			    th:class="${egunaBista.data == null} ? 'blank' : ''"
			    th:classappend="${egunaBista.data != null} ? ${egunMap[egunaBista.data.toString()]} : ''"
			    th:title="${egunaBista.data != null} ? ${deskribapenaMap[egunaBista.data.toString()]} : ''"
			    th:attr="data-date=${egunaBista.data != null ? egunaBista.data : null}"
			    style="cursor: pointer;">
			    <div class="egun-zenbakia"
			         th:text="${egunaBista.data != null ? egunaBista.data.dayOfMonth : ''}"
			         th:classappend="${egunMap[egunaBista.data.toString()] == 'ezlektiboa'} ? ' testu-zuria' : ''"
			         th:style="${egunaBista.data != null && !egunaBista.hilabeteAktibokoa} ? 'color: #ccc;' : 'color: black;'">
			    </div>
			    <!-- Asistentzia botoia (lektiboa bada soilik) -->
				<a th:if="${egunaBista.data != null 
          					and (asistentziaEgunMap[egunaBista.data.toString()] == true)}"
				   th:href="@{/irakasle/asistentzia(data=${egunaBista.data})}"
				   class="btn-asistentzia"
				   title="Egun honetako asistentzia">
				  ðŸ‘¤âœ”
				</a>
			    <!-- Egun honetako jarduerak -->
				  <ul class="jarduerak" th:if="${egunaBista.data != null and jardueraMap[egunaBista.data] != null}">
				    <li class="jarduera-item"
					    th:each="j : ${jardueraMap[egunaBista.data]}"
					    th:text="${ j.titulua + ' - ' + ( #strings.isEmpty(j.mota) ? 'planifikatua' : j.mota ) }"
					    th:attr="data-id=${j.id}"
					    onclick="editatuJarduera(event, this)">
					</li>
				  </ul>
			</td>
		</tr>
    </tbody>
</table>

<!-- MODALA -->
<div id="jardueraModal" class="modal" style="display:none">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 id="jardueraModalTitle">Jarduera berria</h3>
      <button type="button" class="close" onclick="itxiJardueraModala()">Ã—</button>
    </div>

    <!-- FORM nagusia (sortu/eguneratu) -->
    <form th:action="@{/irakasle/denboralizazioa/jarduera}" method="post" id="jardueraForm">
      <input type="hidden" name="id" id="jardueraId">
      <input type="hidden" name="urtea" th:value="${urtea}">
      <input type="hidden" name="hilabetea" th:value="${hilabetea}">
      <input type="hidden" name="data" id="jardueraData">
      <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

      <div class="form-row">
        <label>Titulua</label>
        <input name="titulua" id="jardueraTitulua" type="text" required>
      </div>

      <div class="form-row">
        <label>Deskribapena</label>
        <textarea name="deskribapena" id="jardueraDeskribapena" rows="3"></textarea>
      </div>

      <div class="form-row">
        <label>Orduak</label>
        <input name="orduak" id="jardueraOrduak" type="number" min="0" step="0.25" value="1">
      </div>

      <div class="form-row">
        <label>Mota</label>
        <select name="mota" id="jardueraMota">
          <option value="planifikatua">Planifikatua</option>
          <option value="eginda">Eginda</option>
          <option value="ebaluazioa">Ebaluazioa</option>
        </select>
      </div>

      <!-- Botoiak: Ezabatu ezkerrean, Ezeztatu/Gorde eskuinean -->
      <div class="modal-actions" style="display:flex; align-items:center; gap:.5rem; justify-content:flex-end;">
        <button type="button"
                id="jardueraEzabatuBtn"
                class="btn danger"
                style="display:none; margin-right:auto;"
                onclick="berretsiEtaEzabatu()">Ezabatu</button>

        <button type="button" class="btn secondary" onclick="itxiJardueraModala()">Ezeztatu</button>
        <button type="submit" class="btn primary">Gorde</button>
      </div>
    </form>

    <!-- FORM ezabatzeko (hidden, EZ botoirik) -->
    <form id="jardueraEzabatuForm"
          th:action="@{'/irakasle/denboralizazioa/jarduera/' + 0 + '/ezabatu'}"
          method="post"
          style="display:none;">
      <input type="hidden" name="urtea" th:value="${urtea}">
      <input type="hidden" name="hilabetea" th:value="${hilabetea}">
      <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    </form>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function(){
  const table = document.querySelector('.taula-egutegia');
  if(!table) return;

  table.addEventListener('click', function(e){
    // 1) Asistentzia botoiaren klikak EZ ukitu
    if (e.target.closest('a.btn-asistentzia')) return;

    // 2) Jarduera modala: soilik TD kliketan
    const td = e.target.closest('td[data-date]');
    if (!td) return;

    // data-date balioarekin ireki modala
    if (typeof irekiJardueraModala === 'function') {
      irekiJardueraModala(td);
    }
  });
});
</script>


</body>



</html>
