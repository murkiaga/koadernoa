<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="eu">
<head>
    <meta charset="UTF-8">
    <title>Denboralizazioa</title>
    <link rel="stylesheet" th:href="@{/css/irakasle-navbar.css}">
    <link rel="stylesheet" th:href="@{/css/irakasle-common.css}">
    <link rel="stylesheet" th:href="@{/css/jarduera-modal.css}">
     <!-- CSRF meta tag-ak AJAX-erako -->
    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}"/>
    <style>
        h2, h3 { text-transform: capitalize; }
        .hilabetea { margin-bottom: 2rem; }

        .taula-egutegia {
            width: 100%;
            border-collapse: collapse;
        }
        .taula-egutegia th,
        .taula-egutegia td {
            border: 1px solid #ccc;
            vertical-align: top;
            width: 20%;
            height: 90px;
            position: relative;
        }
        .taula-egutegia th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
            padding: 3px;
            height: 24px;
            font-size: 0.9rem;
        }

        .egun-zenbakia {
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 0.75rem;
            color: #333;
        }

        .blank { background-color: #f0f0f0; }

        .lektibo1 { background-color: var(--ebal1-color); }
		.lektibo2 { background-color: var(--ebal2-color); }
		.lektibo3 { background-color: var(--ebal3-color); }

        /* Jai-egunak: fondo zuria, zenbakia gorriz */
        .jaieguna {
            background-color: #ffffff;
        }
        .jaieguna .egun-zenbakia {
            color: #b91c1c;
            font-weight: 700;
        }
        
        /* Jai-egunen zenbakiari lehentasuna eman (inline style-a gainditzeko) */
		.taula-egutegia td.jaieguna .egun-zenbakia {
		    color: #b91c1c !important;
		    font-weight: 700;
		}

        .ezlektiboa { background-color: black; color: white; }
        .ordezkatua { background-color: yellow; }
        .egun-zenbakia.testu-zuria { color: white !important; }

        .jarduerak{
            list-style:none;margin:22px 4px 4px;padding:0;
            display:flex;flex-direction:column;gap:4px;
        }
        .jarduera-item{
            font-size:.8rem;line-height:1.2;border-radius:6px;
            padding:2px 6px;border:1px solid #e5e7eb;cursor:pointer;
            white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
        }
        .jarduera-item:hover{background:#f3f4f6;}

        /* .btn.danger kolorea globaletik dator, hemen margin auto bakarrik */
        .modal-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        .modal-actions .btn.danger {
            margin-right: auto;
        }

        .bista-tabs {
		    display: flex;
		    gap: .5rem;
		    margin: 1rem 0;
		    border-bottom: 1px solid #e5e7eb;
		    justify-content: center;
		}
        .bista-tabs a {
            padding: .35rem .9rem;
            text-decoration: none;
            color: #374151;
            border-radius: .75rem .75rem 0 0;
            border: 1px solid transparent;
            border-bottom: none;
            font-size: .9rem;
        }
        .bista-tabs a.active {
            border-color: #e5e7eb;
            background: #f9fafb;
            font-weight: 600;
        }

        .faltak-taula {
            width: 100%;
            border-collapse: collapse;
            font-size: .9rem;
        }
        .faltak-taula th,
        .faltak-taula td {
            border: 1px solid #e5e7eb;
            padding: 4px 6px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
        }
        .faltak-taula thead th {
            background: #f3f4f6;
            font-weight: 600;
        }
        .faltak-taula td.ikasle-izena {
            text-align: left;
            white-space: nowrap;
        }
        .faltak-taula tbody tr:nth-child(odd) {
            background: #f9fafb;
        }
        .faltak-taula tbody tr:hover {
            background: #e5e7eb;
        }
        
		.falta-pct-altua { background: #fecaca; }
        .falta-pct-ertaina { background: #fef9c3; }

        .programa-orduak-label {
            font-size: .7rem;
            color: #6b7280;
            display: block;
        }
        
		.faltak-wrapper {
		    width: 100%;
		    overflow-x: auto;
		}
		.faltak-taula {
		    border-collapse: separate;
		    border-spacing: 0;
		    min-width: max-content;
		}
		.faltak-taula th.sticky-col,
		.faltak-taula td.sticky-col {
		    position: sticky;
		    left: 0;
		    z-index: 2;
		}
		.faltak-taula th.sticky-col {
		    background: #f3f4f6;
		}
		.faltak-taula td.sticky-col {
		    background: #ffffff;
		    z-index: 1;
		}
		/* Jarduerak Drag & Drop */
		.jarduera-item{
            font-size:.8rem;line-height:1.2;border-radius:6px;
            padding:2px 6px;border:1px solid #e5e7eb;cursor:pointer;
            white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
            cursor: grab;          /* drag UX politago */
        }
        .jarduera-item:active{
            cursor: grabbing;
        }
        
        .goiko-ikonoak{
		  position:absolute;
		  left:6px;
		  top:4px;
		  display:flex;
		  gap:6px;
		  align-items:center;
		  z-index:3;
		}
		
		/* btn-asistentzia lehen absolutua bazen, hemen gainidatzi */
		.btn-asistentzia{
		  position: static;
		  font-size:.85rem;
		  text-decoration:none;
		  padding:2px 6px;
		  border:1px solid #ddd;
		  border-radius:6px;
		  background:#fff;
		  cursor:pointer;
		}
		.btn-asistentzia:hover{ background:#f3f4f6; }
		
        .ohar-ikonoa{
		  display:inline-flex;
		  align-items:center;
		  justify-content:center;
		  width:18px;
		  height:18px;
		  border-radius:6px;
		  border:1px solid #ddd;
		  background:#fff;
		  font-size:.9rem;
		  font-weight:900;
		  color:#b91c1c;
		  cursor: help;   /* tooltip dagoela adierazi */
		  user-select:none;
		}
		.ohar-ikonoa:hover{ background:#f3f4f6; }

        .denboralizazio-actions{
          display:flex;
          justify-content:flex-end;
          gap:.5rem;
          margin:1rem 0;
          padding:0 1rem;
        }

    </style>
    
    <script th:src="@{/js/jarduera-modal.js}"></script>
</head>

<body>

<!-- Navbar -->
<div th:if="${koadernoAktiboa != null}"
     th:replace="irakasleak/fragments/irakasle-navbar :: navbar(${koadernoAktiboa}, ${irakasleKoadernoAktiboak})"></div>

<div class="denboralizazio-actions">
    <button class="btn btn-primary" type="button" onclick="irekiTxantiloiModala()">
        Gorde txantiloi gisa
    </button>
</div>

<!-- Bista aukeraketa: egutegia vs faltak -->
<div class="bista-tabs">
    <a th:href="@{/irakasle/denboralizazioa(
                    hilabetea=${hilabetea},
                    urtea=${urtea},
                    bista='egutegia')}"
       th:classappend="${bista == null or bista == 'egutegia'} ? ' active'">
        ðŸ—“ Egutegi bista
    </a>

    <a th:href="@{/irakasle/denboralizazioa(
                    hilabetea=${hilabetea},
                    urtea=${urtea},
                    bista='faltak')}"
       th:classappend="${bista == 'faltak'} ? ' active'">
        ðŸ“‹ Falten bista
    </a>
</div>

<!-- FRAGMENT Egutegi Bista -->
<div th:if="${bista == null or bista == 'egutegia'}"
     th:insert="irakasleak/denboralizazioa/egutegi-bista-fragment :: egutegiBista">
</div>

<!-- FRAGMENT Falten Bista -->
<div th:if="${bista == 'faltak'}"
     th:insert="irakasleak/denboralizazioa/falten-bista-fragment :: faltakBista">
</div>

<div id="txantiloiModal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0;">Txantiloia gorde</h3>
            <button class="close" type="button" onclick="itxiTxantiloiModala()">Ã—</button>
        </div>
        <form method="post" th:action="@{/irakasle/denboralizazioa/txantiloiak/sortu}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}">
            <input type="hidden" name="urtea" th:value="${urtea}">
            <input type="hidden" name="hilabetea" th:value="${hilabetea}">
            <div class="form-row">
                <label for="txantiloiIzena">Izena</label>
                <input id="txantiloiIzena" name="izena" type="text"
                       th:attr="placeholder=${ikasturtea != null ? ikasturtea.izena + ' denboralizazioa' : 'Denboralizazioa'}">
            </div>
            <div class="modal-actions">
                <button class="btn secondary" type="button" onclick="itxiTxantiloiModala()">Utzi</button>
                <button class="btn primary" type="submit">Gorde</button>
            </div>
        </form>
    </div>
</div>

<!-- Egutegiaren JS (egutegi fragmentoa dagoenean soilik aurkituko du taula) -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const table = document.querySelector('.taula-egutegia');
  if(!table) return;

  table.addEventListener('click', function(e){
	if (e.target.closest('a.btn-asistentzia') || e.target.closest('.ohar-ikonoa')) return;

    const td = e.target.closest('td[data-date]');
    if (!td) return;

    if (typeof irekiJardueraModala === 'function') {
      irekiJardueraModala(td);
    }
  });
});
</script>

<script>
function irekiTxantiloiModala() {
  const modal = document.getElementById('txantiloiModal');
  if (modal) modal.style.display = 'flex';
}

function itxiTxantiloiModala() {
  const modal = document.getElementById('txantiloiModal');
  if (modal) modal.style.display = 'none';
  const input = document.getElementById('txantiloiIzena');
  if (input) input.value = '';
}

	//Jardueren drag&drop
document.addEventListener('DOMContentLoaded', function(){
  const table = document.querySelector('.taula-egutegia');
  if (!table) return;

  // CSRF datuak meta-etiketatik
  const metaToken  = document.querySelector('meta[name="_csrf"]');
  const metaHeader = document.querySelector('meta[name="_csrf_header"]');
  const CSRF_TOKEN  = metaToken  ? metaToken.content  : null;
  const CSRF_HEADER = metaHeader && metaHeader.content
        ? metaHeader.content
        : 'X-CSRF-TOKEN';

  let draggedItem = null;
  let draggedFromDate = null;

  // DRAG HASIERA
  table.addEventListener('dragstart', function(e){
    const li = e.target.closest('.jarduera-item');
    if (!li) return;

    draggedItem = li;
    const td = li.closest('td[data-date]');
    draggedFromDate = td ? td.getAttribute('data-date') : null;

    e.dataTransfer.effectAllowed = 'move';
  });

  table.addEventListener('dragend', function(){
    draggedItem = null;
    draggedFromDate = null;
  });

  // DROP HELBURUAK: td[data-date]
  table.querySelectorAll('td[data-date]').forEach(td => {

    td.addEventListener('dragover', function(e){
      if (!draggedItem) return;
      e.preventDefault(); // beharrezkoa drop egiteko
      e.dataTransfer.dropEffect = 'move';
    });

    td.addEventListener('drop', async function(e){
      if (!draggedItem) return;
      e.preventDefault();
      e.stopPropagation();

      const targetTd = e.currentTarget;
      const newDate = targetTd.getAttribute('data-date');
      if (!newDate) return;

      if (newDate === draggedFromDate) {
        // Egun berean uzten badu, ez dugu ezer egiten
        return;
      }

      const jardueraId = draggedItem.getAttribute('data-id');
      if (!jardueraId) {
        console.warn('[DND] jardueraId falta da');
        return;
      }

      // -------- BACKENDera deia --------
      try {
        const params = new URLSearchParams();
        params.append('data', newDate);

        const headers = {
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
        };
        if (CSRF_TOKEN) {
          headers[CSRF_HEADER] = CSRF_TOKEN;
        }

        const res = await fetch(`/irakasle/denboralizazioa/jarduera/${jardueraId}/mugitu`, {
          method: 'POST',
          headers,
          body: params.toString()
        });

        if (!res.ok) {
          alert('Ezin izan da jarduera mugitu (HTTP ' + res.status + ').');
          return;
        }

        let json = {};
        try {
          json = await res.json();
        } catch (e2) {
          json = { ok: true }; // kasu arraro batean JSON ez badator
        }

        if (json.error) {
          alert('Ezin izan da jarduera mugitu: ' + json.error);
          return;
        }

        // -------- HEMEN: dena ondo â†’ orria birkargatu --------
        window.location.reload();

      } catch (err) {
        console.error('[DND] Fetch errorea:', err);
        alert('Ezin izan da jarduera mugitu. Saiatu berriro, mesedez.');
        return;
      }
    });
  });
});
</script>




</body>
</html>
