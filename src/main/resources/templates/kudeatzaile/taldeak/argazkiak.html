<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="eu">
<head>
  <meta charset="UTF-8">
  <title th:text="${taldea.izena} + ' â€” Argazkiak'">Argazkiak</title>
  <link rel="stylesheet" th:href="@{/css/navbar.css}">
  <link rel="stylesheet" th:href="@{/css/kudeatzaile-common.css}">

  <!-- CSRF: header + token, entregados por Spring -->
  <meta name="_csrf" th:if="${csrf != null}" th:content="${csrf.token}">
  <meta name="_csrf_header" th:if="${csrf != null}" th:content="${csrf.headerName}">

  
</head>
<body>
  <div th:replace="/kudeatzaile/fragments/navbar :: kudeatzaile-navbar"></div>
<main class="page photo-page">
  <div class="page">
    <div class="topbar">
      <h1 th:text="${taldea.izena} + ' â€” Ikasleen argazkiak'">Ikasleen argazkiak</h1>
      <div style="display:flex; align-items:center; gap:.5rem;">
        <label for="taldeSelector" style="font-size:.9rem;color:#6b7280;">Taldea:</label>
        <select id="taldeSelector" onchange="gotoTeam(this.value)">
          <option th:each="t : ${taldeak}"
                  th:value="${t.id}"
                  th:text="${t.izena}"
                  th:selected="${t.id == taldea.id}">
          </option>
        </select>
        <a th:href="@{/kudeatzaile/taldeak}" style="text-decoration:none">â† Talde zerrendara</a>
      </div>
    </div>

    <div class="grid" th:if="${!#lists.isEmpty(ikasleak)}">
      <div class="card" th:each="ik : ${ikasleak}" th:attr="data-ikasle-id=${ik.id}">
        <button class="upload-cta" type="button" onclick="openPicker(this)">Igo</button>

        <th:block th:with="tick=${#dates.createNow().time / 300000}">
  <img class="ph"
       th:src="${#strings.isEmpty(ik.argazkiPath) 
                ? '/img/avatar-user.svg' 
                : ik.argazkiPath + '?v=' + tick}">
</th:block>

        <div class="progress"><div class="bar"></div></div>

        <div class="meta">
          <div class="surnames"
               th:text="${(ik.abizena1?:'') + (ik.abizena2!=null && !#strings.isEmpty(ik.abizena2) ? ' ' + ik.abizena2 : '')}">
            Abizena1 Abizena2
          </div>
          <div class="name" th:text="${ik.izena}">Izena</div>
          <div class="idline">
            <span th:text="${ik.hna}">HNA</span>
            <span th:if="${ik.nan != null and !#strings.isEmpty(ik.nan)}"
                  th:text="' Â· ' + ${ik.nan}"> Â· NAN</span>
          </div>
        </div>

        <!-- File input ezkutuan, mugikor-kamera onartuta -->
        <input class="hidden-input"
               type="file"
               accept="image/*"
               capture="environment"
               onchange="uploadPhoto(this)"
               th:attr="data-post-url=@{'/kudeatzaile/taldeak/' + ${taldea.id} + '/argazkiak/' + ${ik.id}}">
      </div>
    </div>

    <div th:if="${#lists.isEmpty(ikasleak)}" style="color:#6b7280;">
      Talde honek ez du ikaslerik.
    </div>
  </div>

  <!-- (Opcional) inputs ocultos por si prefieres leerlos en vez de las <meta> -->
  <input type="hidden" id="csrfName"  th:if="${csrf != null}" th:value="${csrf.parameterName}">
  <input type="hidden" id="csrfToken" th:if="${csrf != null}" th:value="${csrf.token}">
  <input type="hidden" id="csrfHeader" th:if="${csrf != null}" th:value="${csrf.headerName}">
</main>
  <script>
    function gotoTeam(id){
      if (!id) return;
      window.location.href = "/kudeatzaile/taldeak/" + id + "/argazkiak";
    }

    function openPicker(btn){
      const card  = btn.closest('.card');
      const input = card.querySelector('.hidden-input');
      input.click();
    }

    function getCsrfFromMeta() {
      const token  = document.querySelector('meta[name="_csrf"]')?.content;
      const header = document.querySelector('meta[name="_csrf_header"]')?.content;
      return { token, header };
    }

    // Fallback por si quieres tirar de los inputs ocultos
    function getCsrf() {
      let { token, header } = getCsrfFromMeta();
      if (!token)  token  = document.getElementById('csrfToken')?.value;
      if (!header) header = document.getElementById('csrfHeader')?.value;
      return { token, header };
    }

    function uploadPhoto(input){
      const card = input.closest('.card');
      const url  = input.getAttribute('data-post-url');
      const img  = card.querySelector('.ph');
      const bar  = card.querySelector('.bar');

      const file = input.files[0];
      if(!file) return;

      // Aurreikuspena berehala
      const prev = URL.createObjectURL(file);
      img.src = prev;

      const form = new FormData();
      form.append('foto', file);

      const { token, header } = getCsrf();
      const xhr = new XMLHttpRequest();
      xhr.open('POST', url, true);

      // ğŸ”´ IMPORTANTE: usar SIEMPRE el headerName que da Spring (p.e. X-XSRF-TOKEN)
      if (token && header) {
        xhr.setRequestHeader(header, token);
      }

      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const p = Math.round(e.loaded * 100 / e.total);
          bar.style.width = p + '%';
        }
      });

      xhr.onreadystatechange = function(){
        if (xhr.readyState === 4) {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const res = JSON.parse(xhr.responseText);
              if (res.ok && res.url) img.src = res.url;
              else alert(res.errorea || 'Ezin izan da irudia gorde.');
            } catch(e) {
              alert('Zerbitzariaren erantzuna baliogabea da.');
            }
          } else {
            alert('Errorea igotzean (' + xhr.status + ').');
          }
          setTimeout(() => bar.style.width = '0%', 600);
          input.value = '';
        }
      };

      xhr.send(form);
    }
  </script>
  <script th:src="@{/js/kudeatzaile-nav.js}"></script>
</body>
</html>
